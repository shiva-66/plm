<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Product sale</title>
    <style>
         body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid white;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        header .company-name {
            text-align: center;
            color: #E6E6FA;
        }
        header .company-name h2 {
            font-family: Arial, sans-serif;
            font-size: 40px;
            font-weight: 900;
            font-style: italic;
            margin-bottom: 10px;
        }
        header .company-name h4 {
            font-family: Arial, sans-serif;
            font-size: 25px;
            font-weight: bold;
            font-style: italic;
            margin: 0;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 25px 0 0 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            margin-bottom: 20px;
        }
        .nav-link {
            color: white !important;
            font-size: 22px;
            padding: 12px 25px;
        }
        .nav-item {
            list-style: none;
            display: inline-block;
            margin-right: 20px;
        }
        .navbar-section a:hover {
            background-color:  #7fb3d5 ;
            color: black !important;
            border-radius: 5px;
        }
        h1{
            font-weight: bold; font-size: 30px; text-align: center; margin-bottom: 20px;color:#1b4f72;
        }
		
        .container {
            width: 80%;
            margin-top: 60px;
            text-align: center;
        }
        
        .accordion {
            background-color: #7fb3d5;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: 0.4s;
            position: relative;
        }
        .accordion::after {
            content: '\25BC';
            font-size: 16px;
            position: absolute;
            right: 10px;
            transition: transform 0.4s;
        }
        .active::after {
            transform: rotate(180deg);
        }
        .active, .accordion:hover {
            background-color: #1b4f72;
            color:white;
        }
        .panel {
            padding: 10px;
            display: none;
            overflow: hidden;
            background-color: white;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            background-color: #d6eaf8;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
            word-wrap: break-word;
        }
        th {
            background-color: #d6eaf8;
            color: black;
            font-weight: bold;
        }
        input {
            width: 90%;
            padding: 5px;
            background-color: #f5f5f5;
            border:1px solid black;
            box-sizing: border-box;
        }
        .submit {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #1b4f72;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            width: 50%;
        }
        .scroll-table {
            overflow-x: auto;
        }

        #dataTable {
            display: none;
        }
        #searchInput {
            width: 250px !important; 
            border: 1px solid #1b4f72;
        }
        .input-group {
            width: auto; 
            display: inline-flex;  
        }
        #searchInput:focus {
            border-color: #1b4f72 !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body>
    <!--header section-->
    <header>
		<img src="logocct.jpg" style="width:100px; height:80px" alt="Company Logo" />
		<div class="company-name">
			<h2>Cloud Chain Technologies</h2> 
			<h4>Karimnagar</h4>
		</div>
	</header>
	<!--navbar section-->
	<div class="navbar-section">
            <ul class="nav justify-content-center">
                <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
                <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
                <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
                <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
            </ul>
        </div>
    <div class="container">
        <h1>Product Sale</h1>
        <div class="container mt-4">
            <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Enter Block Number" >
                <button class="btn btn-primary" onclick="searchBlock()" style="background-color: #1b4f72;">Search</button>
            </div>
        </div>
        <form id="inventoryForm">
            <div id="dataTable">
            <!--First Accordian  -->
            <button type="button" class="accordion">Basic Details</button>
            <div class="panel">
                <div class="scroll-table">
                    <table>
                        <tr><th>Block No.</th><td><label id="block_no">9503</label></td></tr>
                        <tr><th>Block Colour</th><td><label id="block_colour">PSR - TB</label></td></tr>
                        <tr><th>Block Part</th><td><label id="block_parts">Part-A</label></td></tr>
                    </table>
                </div>
            </div>

            <!--Second Accordian  -->
            <button type="button" class="accordion">Marking/Sales Particulars</button>
            <div class="panel">
                <div class="scroll-table">
                    <table>
                        <tr>
                            <th colspan="5">Actual Qty(Before sale)</th>
                        </tr>
                        <tr>
                            <th>Type</th><th colspan="2">No of Pcs</th><th colspan="2">Sft</th>
                        </tr>
                        <tr>
                            <td>Fresh</td>
                            <td colspan="2"><label id="marking_fresh_pcs">20</label></td>
                            <td colspan="2"><label id="marking_fresh_sft"> 700.000 </label></td>
                        </tr>
                        <tr>
                            <td>Semi-Fresh</td>
                            <td colspan="2"><label id="marking_semi_fresh_pcs">10</label></td>
                            <td colspan="2"><label id="marking_semi_fresh_sft"> 100.000 </label></td>
                        </tr>
                        <tr>
                            <td>Commercial</td>
                            <td colspan="2"><label id="marking_commercial_pcs">7</label></td>
                            <td colspan="2"><label id="marking_commercial_sft"> 253.958 </label></td>
                        </tr>

                    
                    </table>
                </div>
            </div>

            <!--Third Accordian  -->
            <button type="button" class="accordion">Closing stock Qty (After sale)(SFT)</button>
            <div class="panel">
                <div class="scroll-table">
                    <table>
                        <tr>
                            <th colspan="5">Closing stock Qty (After sale)(SFT)</th>
                        </tr>
                        <tr>
                            <th>Type</th><th colspan="2">No of Pcs</th><th colspan="2">Sft</th>
                        </tr>
                        <tr>
                            <td>Fresh</td>
                            <td colspan="2"><label id="closing_fresh_pcs">20</label></td>
                            <td colspan="2"><label id="closing_fresh_sft"> 700.000 </label></td>
                        </tr>
                        <tr>
                            <td>Semi-Fresh</td>
                            <td colspan="2"><label id="closing_semi_fresh_pcs">10</label></td>
                            <td colspan="2"><label id="closing_semi_fresh_sft"> 100.000 </label></td>
                        </tr>
                        <tr>
                            <td>Commercial</td>
                            <td colspan="2"><label id="closing_commercial_pcs">7</label></td>
                            <td colspan="2"><label id="closing_commercial_sft"> 253.958 </label></td>
                        </tr>
                        <tr>
                            <td>Total Qty (SFT) Fresh/Semi+Commrl</td>
                            <td colspan="2"><label id="closing_total_pcs" >37</label></td>
                            <td colspan="2"><label id="closing_total_sft" >  1053.958 </label></td>
                        </tr>
                    </table>
                    
                </div>
            </div>


            <!--fourth Accordian  -->
            <button type="button" class="accordion">Product Sale</button>
            <div class="panel">
                <div class="scroll-table">
                    <table>
                        <tr>
                            <th colspan="5">Product Sale</th>
                        </tr>
                        <tr>
                            <th>Type</th><th colspan="2">No of Pcs</th><th colspan="2">Sft</th>
                        </tr>
                        <tr>
                            <td>Fresh</td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_fresh_pcs" id="sale_fresh_pcs"></td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_fresh_sft" id="sale_fresh_sft"></td>
                        </tr>
                        <tr>
                            <td>Semi-Fresh</td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_semi_fresh_pcs" id="sale_semi_fresh_pcs"></td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_semi_fresh_sft" id="sale_semi_fresh_sft"></td>
                        </tr>
                        <tr>
                            <td>Commercial</td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_commercial_pcs" id="sale_commercial_pcs"></td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_commercial_sft" id="sale_commercial_sft"></td>
                        </tr>
                        <tr>
                            <td>Total Qty (SFT) Fresh/Semi+Commrl</td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_total_pcs"  id="sale_total_pcs"readonly></td>
                            <td colspan="2"><input type="number" step="0.01" name="sale_total_sft"  id="sale_total_sft"readonly></td>
                        </tr>
                    </table>
                    
                </div>
            </div>
           
            <!--Fifth Accordian  -->
            <button type="button" class="accordion">Incharge  Information</button>
            <div class="panel">
                <table>
                    <tr><th>Supervisor Name</th><td><input type="text" name="supervisor_name" id="supervisor_name"></td></tr>
                    <tr><th>Incharge Name</th><td><input type="text" name="incharge_name" id="incharge_name"></td></tr>
                </table>
            </div>
            
            <br>
            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="submit" style="display: none">Submit</button>
				<button type="submit" class="submit" style="display: none">Submit</button>
				<button type="submit" class="submit">Submit</button>
			</div>
        </div>
        </form>
    </div>

    <script>
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.display === "block") {
                    panel.style.display = "none";
                } else {
                    panel.style.display = "block";
                }
            });
        }

        function searchBlock() {
            let searchValue = document.getElementById("searchInput").value.trim();
            let table = document.getElementById("dataTable");
           let blockNo = document.getElementById("block_no").textContent;

           if (!searchValue) {
               table.style.display = "none";
               alert("Please enter a block number to search!");
              return;
        }

    // For this example, we'll just compare with the static block number (9503)
    
           if (searchValue === blockNo) {
              table.style.display = "block"; 
            }
           else {
             table.style.display = "none";   
                 alert("Block number " + searchValue + " not found!");
            }
        }
		
		function calculateClosingStockDamage() {
			
			function getText(id) {
				return parseFloat(document.getElementById(id)?.textContent) || 0;
			}

			// Function to update text content
			function setText(id, value) {
				if (document.getElementById(id)) {
					document.getElementById(id).textContent = value;
				}
			}

			// Function to ensure stock never goes below zero
			function validateStock(available, sold) {
				return Math.max(0, available - sold);
			}

			// Get sale input values (how much is being sold)
			let freshPcs = getValue("sale_fresh_pcs");
			let freshSft = getValue("sale_fresh_sft");
			let semiFreshPcs = getValue("sale_semi_fresh_pcs");
			let semiFreshSft = getValue("sale_semi_fresh_sft");
			let commercialPcs = getValue("sale_commercial_pcs");
			let commercialSft = getValue("sale_commercial_sft");

			// Get actual stock before sale
			let markingFreshPcs = parseInt(getText("marking_fresh_pcs")) || 0;
			let markingFreshSft = parseFloat(getText("marking_fresh_sft")) || 0;
			let markingSemiFreshPcs = parseInt(getText("marking_semi_fresh_pcs")) || 0;
			let markingSemiFreshSft = parseFloat(getText("marking_semi_fresh_sft")) || 0;
			let markingCommercialPcs = parseInt(getText("marking_commercial_pcs")) || 0;
			let markingCommercialSft = parseFloat(getText("marking_commercial_sft")) || 0;

			// Calculate closing stock (after sale)
			let closingFreshPcs = validateStock(markingFreshPcs, freshPcs);
			let closingFreshSft = validateStock(markingFreshSft, freshSft);
			let closingSemiFreshPcs = validateStock(markingSemiFreshPcs, semiFreshPcs);
			let closingSemiFreshSft = validateStock(markingSemiFreshSft, semiFreshSft);
			let closingCommercialPcs = validateStock(markingCommercialPcs, commercialPcs);
			let closingCommercialSft = validateStock(markingCommercialSft, commercialSft);

			// Update the closing stock display
			setText("closing_fresh_pcs", closingFreshPcs);
			setText("closing_fresh_sft", closingFreshSft.toFixed(3));
			setText("closing_semi_fresh_pcs", closingSemiFreshPcs);
			setText("closing_semi_fresh_sft", closingSemiFreshSft.toFixed(3));
			setText("closing_commercial_pcs", closingCommercialPcs);
			setText("closing_commercial_sft", closingCommercialSft.toFixed(3));

			// Calculate and update total closing values
			let totalClosingPcs = closingFreshPcs + closingSemiFreshPcs + closingCommercialPcs;
			let totalClosingSft = closingFreshSft + closingSemiFreshSft + closingCommercialSft;

			setText("closing_total_pcs", totalClosingPcs);
			setText("closing_total_sft", totalClosingSft.toFixed(3));

			// Update total sale fields
			document.getElementById("sale_total_pcs").value = parseInt(freshPcs) + parseInt(semiFreshPcs) + parseInt(commercialPcs);
			document.getElementById("sale_total_sft").value = (parseFloat(freshSft) + parseFloat(semiFreshSft) + parseFloat(commercialSft)).toFixed(3);
		}

		// Attach event listeners to update stock whenever an input changes
		document.querySelectorAll("input").forEach(input => {
			input.addEventListener("input", calculateClosingStockDamage);
		});
		
		document.getElementById("inventoryForm").addEventListener("submit", function(event) {
			event.preventDefault(); 
			let isValid = true;

			this.querySelectorAll('input[required]').forEach(input => {
				if (!input.value.trim()) {
					isValid = false;
					input.classList.add("error");
				} else {
					input.classList.remove("error");
				}
			});

			if (isValid) {
				submitForm();
				alert("Submit form has got triggered!");
			} else {
				alert("Please fill all required fields.");
			}
		});
		
		function submitForm() {
			event.preventDefault();

			let recordId = "67dd4a2e420df42a00001803"; // Replace with actual record ID
			let blockParts = getInnerText("block_parts").toLowerCase().trim(); 
			var blockPart;
			let parts = blockParts.split("-");  
			if(parts[1]=="a"){
				blockPart="part_a";
			}
			else if(parts[1]=="b"){
				blockPart="part_b";
			}
			else{
				blockPart="part_c";
			}

			if (!blockPart) {
				alert("Please select a Block Part.");
				return;
			}

			var xhr = new XMLHttpRequest();

			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						let existingData = JSON.parse(xhr.responseText);
						updateRecord(existingData, blockPart, recordId);
					} else if (xhr.status === 404) {
						alert("Error: Record not found. Please check the record ID.");
					} else {
						alert("Error fetching existing data. Status: " + xhr.status);
					}
				}
			};

			xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
			xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
			xhr.send();
		}

		function updateRecord(existingData, blockPart, recordId) {
			let existingPart = existingData.dressing?.[blockPart] || {};

			let updatedPart = {
				...existingPart, // Keep all existing data
				sales_report: {
					fresh: {
						sale_fresh_pcs:  getValue("sale_fresh_pcs"),
						sale_fresh_sft: getValue("sale_fresh_sft")
					},
					semi_fresh: {
						sale_semi_fresh_pcs: getValue("sale_semi_fresh_pcs"),
						sale_semi_fresh_sft: getValue("sale_semi_fresh_sft")
					},
					commercial: {
						sale_commercial_pcs: getValue("sale_commercial_pcs"),
						sale_commercial_sft: getValue("sale_commercial_sft")
					},
					sale_total_pcs: getValue("sale_total_pcs"),
					sale_total_sft: getValue("sale_total_sft"),
					closing_stock_after_sale: {
						fresh: {
							closing_fresh_pcs: getInnerText("closing_fresh_pcs"),
							closing_fresh_sft:  getInnerText("closing_fresh_sft")
						},
						semi_fresh: {
							closing_semi_fresh_pcs: getInnerText("closing_semi_fresh_pcs"),
							closing_semi_fresh_sft: getInnerText("closing_semi_fresh_sft")
						},
						commercial: {
							closing_commercial_pcs: getInnerText("closing_commercial_pcs"),
							closing_commercial_sft: getInnerText("closing_commercial_sft")
						},
						closing_total_pcs: getInnerText("closing_total_pcs"),
						closing_total_sft: getInnerText("closing_total_sft")
					},
					supervisor_name: getValue("supervisor_name"),
					incharge_name: getValue("incharge_name")
				}
			};

			let updatedData = {
				...existingData,
				dressing: {
					...existingData.dressing,
					[blockPart]: updatedPart
				}
			};

			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200 || xhr.status === 201) {
						alert("Stage-4 data updated successfully!");
					} else {
						alert("Error updating Stage-4 data. Status: " + xhr.status);
					}
				}
			};

			xhr.open("PATCH", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
			xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.send(JSON.stringify(updatedData));
		}

	
		function getValue(id) {
			return document.getElementById(id)?.value || "";
		}
	
		// Function to get text values (handles empty fields)
		function getInnerText(id) {
			return document.getElementById(id)?.textContent || "";
		}
	

    </script>
</body>
</html>
