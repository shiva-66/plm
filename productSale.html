<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Product Sale</title>
    <style>
        /* Your existing CSS styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid white;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        header .company-name {
            text-align: center;
            color: #E6E6FA;
        }
        header .company-name h2 {
            font-family: Arial, sans-serif;
            font-size: 40px;
            font-weight: 900;
            font-style: italic;
            margin-bottom: 10px;
        }
        header .company-name h4 {
            font-family: Arial, sans-serif;
            font-size: 25px;
            font-weight: bold;
            font-style: italic;
            margin: 0;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 25px 0 0 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            margin-bottom: 20px;
        }
        .nav-link {
            color: white !important;
            font-size: 22px;
            padding: 12px 25px;
        }
        .nav-item {
            list-style: none;
            display: inline-block;
            margin-right: 20px;
        }
        .navbar-section a:hover {
            background-color: #7fb3d5;
            color: black !important;
            border-radius: 5px;
        }
        h1 {
            font-weight: bold; font-size: 30px; text-align: center; margin-bottom: 20px; color: #1b4f72;
        }
        .container {
            width: 80%;
            margin-top: 60px;
            text-align: center;
        }
        .accordion {
            background-color: #7fb3d5;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: 0.4s;
            position: relative;
        }
        .accordion::after {
            content: '\25BC';
            font-size: 16px;
            position: absolute;
            right: 10px;
            transition: transform 0.4s;
        }
        .active::after {
            transform: rotate(180deg);
        }
        .active, .accordion:hover {
            background-color: #1b4f72;
            color: white;
        }
        .panel {
            padding: 10px;
            display: none;
            overflow: hidden;
            background-color: white;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            background-color: #d6eaf8;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
            word-wrap: break-word;
        }
        th {
            background-color: #d6eaf8;
            color: black;
            font-weight: bold;
        }
        input {
            width: 90%;
            padding: 5px;
            background-color: #f5f5f5;
            border: 1px solid black;
            box-sizing: border-box;
        }
        .submit {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #1b4f72;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            width: 50%;
        }
        .scroll-table {
            overflow-x: auto;
        }
        #dataTable {
            display: none;
        }
        #searchInput {
            width: 250px !important;
            border: 1px solid #1b4f72;
        }
        .input-group {
            width: auto;
            display: inline-flex;
        }
        #searchInput:focus {
            border-color: #1b4f72 !important;
            box-shadow: none !important;
        }
		.error {
			border: 2px solid red !important;
			background-color: #ffebee !important;
		}

		.error-alerted {
			/* Just used as a flag, no styling needed */
		}
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <img src="logocct.jpg" style="width:100px; height:80px" alt="Company Logo" />
        <div class="company-name">
            <h2>CCT Stonexa</h2> 
            <h4>Karimnagar</h4>
        </div>
    </header>

    <!-- Navbar Section -->
    <div class="navbar-section">
        <ul class="nav justify-content-center">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
            <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
            <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
            <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
            <li class="nav-item"><a class="nav-link" href="slabsReport.html">Slabs Report</a></li>
            <li class="nav-item"><a class="nav-link" href="graphReport.html">Graph Report</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1>Product Sale</h1>
        <div class="container mt-4">
            <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Enter Block Number">
                <button class="btn btn-primary" onclick="searchBlock()" style="background-color: #1b4f72;">Search</button>
            </div>
        </div>
        <form id="inventoryForm">
            <div id="dataTable">
                <!-- First Accordion: Basic Details -->
                <button type="button" class="accordion">Basic Details</button>
                <div class="panel">
                    <div class="scroll-table">
                        <table>
                            <tr>
                                <th>Block No.</th>
                                <td><label id="block_no"></label></td>
                            </tr>
                            <tr>
                                <th>Block Colour</th>
                                <td><label id="block_colour"></label></td>
                            </tr>
                            <tr>
                                <th>Block Part</th>
                                <td>
                                    <select name="block_parts" id="block_parts" onchange="updateFormFields()">
                                        <option value="part_a">Part A</option>
                                        <option value="part_b">Part B</option>
                                        <option value="part_c">Part C</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Second Accordion: Marking/Sales Particulars -->
                <button type="button" class="accordion">Marking/Sales Particulars</button>
                <div class="panel">
                    <div class="scroll-table">
                        <table>
                            <tr>
                                <th colspan="5">Actual Qty (Before Sale)</th>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <th colspan="2">No of Pcs</th>
                                <th colspan="2">Sft</th>
                            </tr>
                            <tr>
                                <td>Fresh</td>
                                <td colspan="2"><label id="marking_fresh_pcs"></label></td>
                                <td colspan="2"><label id="marking_fresh_sft"></label></td>
                            </tr>
                            <tr>
                                <td>Semi-Fresh</td>
                                <td colspan="2"><label id="marking_semi_fresh_pcs"></label></td>
                                <td colspan="2"><label id="marking_semi_fresh_sft"></label></td>
                            </tr>
                            <tr>
                                <td>Commercial</td>
                                <td colspan="2"><label id="marking_commercial_pcs"></label></td>
                                <td colspan="2"><label id="marking_commercial_sft"></label></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Third Accordion: Closing Stock Qty (After Sale) -->
                <button type="button" class="accordion">Closing Stock Qty (After Sale)</button>
                <div class="panel">
                    <div class="scroll-table">
                        <table>
                            <tr>
                                <th colspan="5">Closing Stock Qty (After Sale)</th>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <th colspan="2">No of Pcs</th>
                                <th colspan="2">Sft</th>
                            </tr>
                            <tr>
                                <td>Fresh</td>
                                <td colspan="2"><label id="closing_fresh_pcs"></label></td>
                                <td colspan="2"><label id="closing_fresh_sft"></label></td>
                            </tr>
                            <tr>
                                <td>Semi-Fresh</td>
                                <td colspan="2"><label id="closing_semi_fresh_pcs"></label></td>
                                <td colspan="2"><label id="closing_semi_fresh_sft"></label></td>
                            </tr>
                            <tr>
                                <td>Commercial</td>
                                <td colspan="2"><label id="closing_commercial_pcs"></label></td>
                                <td colspan="2"><label id="closing_commercial_sft"></label></td>
                            </tr>
                            <tr>
                                <td>Total Qty (SFT) Fresh/Semi+Commrl</td>
                                <td colspan="2"><label id="closing_total_pcs"></label></td>
                                <td colspan="2"><label id="closing_total_sft"></label></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Fourth Accordion: Product Sale -->
                <button type="button" class="accordion">Product Sale</button>
                <div class="panel">
                    <div class="scroll-table">
                        <table>
                            <tr>
                                <th colspan="5">Product Sale</th>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <th colspan="2">No of Pcs</th>
                                <th colspan="2">Sft</th>
                            </tr>
                            <tr>
                                <td>Fresh</td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_fresh_pcs" id="sale_fresh_pcs"></td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_fresh_sft" id="sale_fresh_sft"></td>
                            </tr>
                            <tr>
                                <td>Semi-Fresh</td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_semi_fresh_pcs" id="sale_semi_fresh_pcs"></td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_semi_fresh_sft" id="sale_semi_fresh_sft"></td>
                            </tr>
                            <tr>
                                <td>Commercial</td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_commercial_pcs" id="sale_commercial_pcs"></td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_commercial_sft" id="sale_commercial_sft"></td>
                            </tr>
                            <tr>
                                <td>Total Qty (SFT) Fresh/Semi+Commrl</td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_total_pcs" id="sale_total_pcs" readonly></td>
                                <td colspan="2"><input type="number" step="0.01" name="sale_total_sft" id="sale_total_sft" readonly></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Fifth Accordion: Incharge Information -->
                <button type="button" class="accordion">Incharge Information</button>
                <div class="panel">
                    <table>
                        <tr>
                            <th>Supervisor Name</th>
                            <td><input type="text" name="supervisor_name" id="supervisor_name"></td>
                        </tr>
                        <tr>
                            <th>Incharge Name</th>
                            <td><input type="text" name="incharge_name" id="incharge_name"></td>
                        </tr>
                    </table>
                </div>

                <!-- Submit Button -->
                <br>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="submit">Submit</button>
                </div>
            </div>
        </form>
    </div>

   <script>
    // Global variable to store original stock values
    let originalStocks = {};
	let previousSoldStocks = {};
    let record_id;

    // Accordion functionality
    var acc = document.getElementsByClassName("accordion");
    for (var i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
                panel.style.display = "none";
            } else {
                panel.style.display = "block";
            }
        });
    }

    // Search block functionality
    function searchBlock() {
        let searchValue = document.getElementById("searchInput").value.trim();
        let table = document.getElementById("dataTable");

        if (!searchValue) {
            table.style.display = "none";
            alert("Please enter a block number to search!");
            return;
        }

        fetchDataFromAPI(searchValue);
    }

    // Fetch data from API
    function fetchDataFromAPI(blockNumber, part = "part_a") {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    let data = JSON.parse(xhr.responseText);
                    record_id = data[0]._id;
                    populateFormFields(data, part);
                    document.getElementById("dataTable").style.display = "block";
                } else if (xhr.status === 404) {
                    alert("Block number " + blockNumber + " not found!");
                } else {
                    alert("Error fetching data. Status: " + xhr.status);
                }
            }
        };

        xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db?q={"id":"${blockNumber}"}`);
        xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
        xhr.send();
    }

    let previousPart = "part_a";

    function populateFormFields(data, part) {
        if (data.length > 0) {
            let record = data[0];

            if (!record.dressing?.[part]?.marking_sales_particulars) {
                alert(`No data found for ${part.toUpperCase()}. Please select another part.`);
                document.getElementById("block_parts").value = previousPart || "part_a";
                return;
            }

            previousPart = part;

            // Populate Basic Details
            document.getElementById("block_no").textContent = record.id || "";
            document.getElementById("block_colour").textContent = record.blocks?.block_color || "";

            // Populate Marking/Sales Particulars
            let markingSales = record.dressing?.[part]?.marking_sales_particulars;
            document.getElementById("marking_fresh_pcs").textContent = markingSales?.fresh?.fresh_pcs || 0;
            document.getElementById("marking_fresh_sft").textContent = markingSales?.fresh?.fresh_sft || 0;
            document.getElementById("marking_semi_fresh_pcs").textContent = markingSales?.semi_fresh?.semi_fresh_pcs || 0;
            document.getElementById("marking_semi_fresh_sft").textContent = markingSales?.semi_fresh?.semi_fresh_sft || 0;
            document.getElementById("marking_commercial_pcs").textContent = markingSales?.commercial?.commercial_pcs || 0;
            document.getElementById("marking_commercial_sft").textContent = markingSales?.commercial?.commercial_sft || 0;

            // Store original values when first loading
           let closingStock = record.dressing?.[part]?.sales_report?.closing_stock_after_sale;
            originalStocks = {
                fresh_pcs: parseFloat(closingStock?.fresh?.closing_fresh_pcs || markingSales?.fresh?.fresh_pcs),
                fresh_sft: parseFloat(closingStock?.fresh?.closing_fresh_sft || markingSales?.fresh?.fresh_sft),
                semi_fresh_pcs: parseFloat(closingStock?.semi_fresh?.closing_semi_fresh_pcs || markingSales?.semi_fresh?.semi_fresh_pcs),
                semi_fresh_sft: parseFloat(closingStock?.semi_fresh?.closing_semi_fresh_sft || markingSales?.semi_fresh?.semi_fresh_sft),
                commercial_pcs: parseFloat(closingStock?.commercial?.closing_commercial_pcs || markingSales?.commercial?.commercial_pcs),
                commercial_sft: parseFloat(closingStock?.commercial?.closing_commercial_sft || markingSales?.commercial?.commercial_sft)
            };
			
			// Store previous sales values when first loading
			let soldStocks = record.dressing?.[part]?.sales_report;
			previousSoldStocks = {
				fresh_pcs: parseFloat(soldStocks?.fresh?.sale_fresh_pcs) || 0,
				fresh_sft: parseFloat(soldStocks?.fresh?.sale_fresh_sft) || 0,
				semi_fresh_pcs: parseFloat(soldStocks?.semi_fresh?.sale_semi_fresh_pcs) || 0,
				semi_fresh_sft: parseFloat(soldStocks?.semi_fresh?.sale_semi_fresh_sft) || 0,
				commercial_pcs: parseFloat(soldStocks?.commercial?.sale_commercial_pcs) || 0,
				commercial_sft: parseFloat(soldStocks?.commercial?.sale_commercial_sft) || 0,
				sale_total_pcs: parseFloat(soldStocks?.sale_total_pcs) || 0,
				sale_total_sft: parseFloat(soldStocks?.sale_total_sft) || 0
			};
			
            // Initialize closing stock with original values
            document.getElementById("closing_fresh_pcs").textContent = originalStocks.fresh_pcs;
            document.getElementById("closing_fresh_sft").textContent = originalStocks.fresh_sft.toFixed(3);
            document.getElementById("closing_semi_fresh_pcs").textContent = originalStocks.semi_fresh_pcs;
            document.getElementById("closing_semi_fresh_sft").textContent = originalStocks.semi_fresh_sft.toFixed(3);
            document.getElementById("closing_commercial_pcs").textContent = originalStocks.commercial_pcs;
            document.getElementById("closing_commercial_sft").textContent = originalStocks.commercial_sft.toFixed(3);
            
            // Initialize totals
            const totalPcs = originalStocks.fresh_pcs + originalStocks.semi_fresh_pcs + originalStocks.commercial_pcs;
            const totalSft = originalStocks.fresh_sft + originalStocks.semi_fresh_sft + originalStocks.commercial_sft;
            document.getElementById("closing_total_pcs").textContent = totalPcs;
            document.getElementById("closing_total_sft").textContent = totalSft.toFixed(3);
            
            // Clear sale inputs
            document.getElementById("sale_fresh_pcs").value = "";
            document.getElementById("sale_fresh_sft").value = "";
            document.getElementById("sale_semi_fresh_pcs").value = "";
            document.getElementById("sale_semi_fresh_sft").value = "";
            document.getElementById("sale_commercial_pcs").value = "";
            document.getElementById("sale_commercial_sft").value = "";
            document.getElementById("sale_total_pcs").value = "";
            document.getElementById("sale_total_sft").value = "";

            // Populate Incharge Information
            let salesReport = record.dressing?.[part]?.sales_report;
            document.getElementById("supervisor_name").value = salesReport?.supervisor_name || "";
            document.getElementById("incharge_name").value = salesReport?.incharge_name || "";
        } else {
            alert("No data found for the given block number!");
        }
    }

    function updateFormFields() {
        let selectedPart = document.getElementById("block_parts").value;
        let blockNumber = document.getElementById("searchInput").value.trim();

        if (blockNumber) {
            fetchDataFromAPI(blockNumber, selectedPart);
        } else {
            alert("Please enter a block number first!");
        }
    }

    function calculateClosingStockDamage() {
        // Get current sale inputs (0 if empty)
        const freshPcs = parseFloat(document.getElementById("sale_fresh_pcs").value) || 0;
        const freshSft = parseFloat(document.getElementById("sale_fresh_sft").value) || 0;
        const semiFreshPcs = parseFloat(document.getElementById("sale_semi_fresh_pcs").value) || 0;
        const semiFreshSft = parseFloat(document.getElementById("sale_semi_fresh_sft").value) || 0;
        const commercialPcs = parseFloat(document.getElementById("sale_commercial_pcs").value) || 0;
        const commercialSft = parseFloat(document.getElementById("sale_commercial_sft").value) || 0;

        // Calculate closing stocks based on ORIGINAL values
        const closingFreshPcs = originalStocks.fresh_pcs - freshPcs;
        const closingFreshSft = originalStocks.fresh_sft - freshSft;
        const closingSemiFreshPcs = originalStocks.semi_fresh_pcs - semiFreshPcs;
        const closingSemiFreshSft = originalStocks.semi_fresh_sft - semiFreshSft;
        const closingCommercialPcs = originalStocks.commercial_pcs - commercialPcs;
        const closingCommercialSft = originalStocks.commercial_sft - commercialSft;

        // Update closing stock display
        document.getElementById("closing_fresh_pcs").textContent = closingFreshPcs;
        document.getElementById("closing_fresh_sft").textContent = closingFreshSft.toFixed(3);
        document.getElementById("closing_semi_fresh_pcs").textContent = closingSemiFreshPcs;
        document.getElementById("closing_semi_fresh_sft").textContent = closingSemiFreshSft.toFixed(3);
        document.getElementById("closing_commercial_pcs").textContent = closingCommercialPcs;
        document.getElementById("closing_commercial_sft").textContent = closingCommercialSft.toFixed(3);

        // Calculate totals
        const totalClosingPcs = closingFreshPcs + closingSemiFreshPcs + closingCommercialPcs;
        const totalClosingSft = closingFreshSft + closingSemiFreshSft + closingCommercialSft;
        const totalSalePcs = freshPcs + semiFreshPcs + commercialPcs;
        const totalSaleSft = freshSft + semiFreshSft + commercialSft;

        // Update total fields
        document.getElementById("closing_total_pcs").textContent = totalClosingPcs;
        document.getElementById("closing_total_sft").textContent = totalClosingSft.toFixed(3);
        document.getElementById("sale_total_pcs").value = totalSalePcs;
        document.getElementById("sale_total_sft").value = totalSaleSft.toFixed(3);
    }

    // Event listeners
    document.querySelectorAll("#sale_fresh_pcs, #sale_fresh_sft, #sale_semi_fresh_pcs, #sale_semi_fresh_sft, #sale_commercial_pcs, #sale_commercial_sft").forEach(input => {
        input.addEventListener("change", function() {
            calculateClosingStockDamage();
        });
        
        // Real-time validation (visual only)
        input.addEventListener("input", function() {
            const closingFieldId = this.id.replace("sale_", "closing_");
            const maxValue = parseFloat(document.getElementById(closingFieldId).textContent) || 0;
            const enteredValue = parseFloat(this.value) || 0;
            
            if (this.value && enteredValue > maxValue) {
                this.classList.add("invalid");
            } else {
                this.classList.remove("invalid");
            }
        });
    });

    // Form submission handling
    document.getElementById("inventoryForm").addEventListener("submit", function(event) {
        event.preventDefault();
        let isValid = true;

        // Check required fields
        this.querySelectorAll('input[required]').forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add("error");
            } else {
                input.classList.remove("error");
            }
        });

        // Additional validation for sale quantities
        let alertShown = false;
        document.querySelectorAll("#sale_fresh_pcs, #sale_fresh_sft, #sale_semi_fresh_pcs, #sale_semi_fresh_sft, #sale_commercial_pcs, #sale_commercial_sft").forEach(input => {
            const closingFieldId = input.id.replace("sale_", "");
            const maxValue = parseFloat(originalStocks[closingFieldId]) || 0;
            const enteredValue = parseFloat(input.value) || 0;
            
            if (enteredValue > maxValue) {
                isValid = false;
                input.classList.add("error");
                if (!alertShown) {
                    alert(`Cannot enter more than available stock (Max: ${maxValue}) for ${input.id.replace("sale_", "").replace(/_/g, " ")}`);
                    alertShown = true;
                }
            } else {
                input.classList.remove("error");
            }
        });

        if (isValid) {
            submitForm();
        } else {
            if (!alertShown) {
                alert("Please correct the errors before submitting.");
            }
        }
    });

    function submitForm() {
        let blockParts = document.getElementById("block_parts").value;

        if (!blockParts) {
            alert("Please select a Block Part.");
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    let existingData = JSON.parse(xhr.responseText);
                    updateRecord(existingData, blockParts, record_id);
                } else if (xhr.status === 404) {
                    alert("Error: Record not found. Please check the record ID.");
                } else {
                    alert("Error fetching existing data. Status: " + xhr.status);
                }
            }
        };

        xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${record_id}`);
        xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
        xhr.send();
    }

    function updateRecord(existingData, blockPart, recordId) {
        let existingPart = existingData.dressing?.[blockPart] || {};

        let updatedPart = {
            ...existingPart,
            sales_report: {
                fresh: {
                    sale_fresh_pcs: (getValue("sale_fresh_pcs") + previousSoldStocks.fresh_pcs) || 0,
                    sale_fresh_sft: (getValue("sale_fresh_sft") + previousSoldStocks.fresh_sft) || 0
                },
                semi_fresh: {
                    sale_semi_fresh_pcs: (getValue("sale_semi_fresh_pcs")+previousSoldStocks.semi_fresh_pcs) || 0,
                    sale_semi_fresh_sft: (getValue("sale_semi_fresh_sft")+previousSoldStocks.semi_fresh_sft) || 0
                },
                commercial: {
                    sale_commercial_pcs: (getValue("sale_commercial_pcs")+ previousSoldStocks.commercial_pcs) || 0,
                    sale_commercial_sft: (getValue("sale_commercial_sft")+ previousSoldStocks.commercial_sft) || 0
                },
                sale_total_pcs: (getValue("sale_total_pcs")+ previousSoldStocks.sale_total_pcs) || 0,
                sale_total_sft: (getValue("sale_total_sft")+ previousSoldStocks.sale_total_sft) || 0,
                closing_stock_after_sale: {
                    fresh: {
                        closing_fresh_pcs: document.getElementById("closing_fresh_pcs").textContent || 0,
                        closing_fresh_sft: document.getElementById("closing_fresh_sft").textContent || 0
                    },
                    semi_fresh: {
                        closing_semi_fresh_pcs: document.getElementById("closing_semi_fresh_pcs").textContent || 0,
                        closing_semi_fresh_sft: document.getElementById("closing_semi_fresh_sft").textContent || 0
                    },
                    commercial: {
                        closing_commercial_pcs: document.getElementById("closing_commercial_pcs").textContent || 0,
                        closing_commercial_sft: document.getElementById("closing_commercial_sft").textContent || 0
                    },
                    closing_total_pcs: document.getElementById("closing_total_pcs").textContent || 0,
                    closing_total_sft: document.getElementById("closing_total_sft").textContent || 0
                },
                supervisor_name: document.getElementById("supervisor_name").value || "",
                incharge_name: document.getElementById("incharge_name").value || ""
            }
        };

        let updatedData = {
            ...existingData,
            dressing: {
                ...existingData.dressing,
                [blockPart]: updatedPart
            }
        };

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200 || xhr.status === 201) {
                    alert("Sale data updated successfully!");
                    window.location.href = `salesreport.html?block_id=${recordId}`;
                } else {
                    alert("Error updating Stage-4 data. Status: " + xhr.status);
                }
            }
        };

        xhr.open("PATCH", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
        xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(updatedData));
		
		function getValue(id){
			return parseFloat(document.getElementById(id).value)
		}
    }
</script>
</body>
</html>