<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Stage 2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid white;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        header .company-name {
            text-align: center;
            color: #E6E6FA;
        }
        header .company-name h2 {
            font-family: Arial, sans-serif;
            font-size: 40px;
            font-weight: 900;
            font-style: italic;
            margin-bottom: 10px;
        }
        header .company-name h4 {
            font-family: Arial, sans-serif;
            font-size: 25px;
            font-weight: bold;
            font-style: italic;
            margin: 0;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 25px 0 0 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            margin-bottom: 20px;
        }
        .nav-link {
            color: white !important;
            font-size: 22px;
            padding: 12px 25px;
        }
        .nav-item {
            list-style: none;
            display: inline-block;
            margin-right: 20px;
        }
        .navbar-section a:hover {
            background-color:  #7fb3d5 ;
            color: black !important;
            border-radius: 5px;
        }
        h1{
			font-weight: bold; 
			font-size: 30px; 
			text-align: center; 
			margin-bottom: 20px;color:#1b4f72;
		}
		
        .container {
           width: 80%;
           margin-top: 60px;
           text-align: center;

        }
        .accordion {
            background-color: #7fb3d5;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: 0.4s;
            position: relative;
        }
        .accordion::after {
            content: '\25BC';
            font-size: 16px;
            position: absolute;
            right: 10px;
            transition: transform 0.4s;
        }
        .active::after {
            transform: rotate(180deg);
        }
        .active, .accordion:hover {
            background-color:#1b4f72;
            color:white;
        }
        .panel {
            padding: 10px;
            display: none;
            overflow: hidden;
            background-color: white;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse !important;
			background-color: #d6eaf8  ;
        }
        th, td {
            border: 1px solid black !important;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #d6eaf8  ;
        }
        input {
            width: 90%;
            padding: 5px;
			background-color: #F5F5F5;
			border:1px solid black;
        }
        .submit {
            padding: 10px 20px;
            font-size: 18px; 
            background-color: #1b4f72;
            color: white;
            border: none; 
            cursor: pointer; 
            border-radius: 5px;
            width: 15%;  
            display: inline-block; 
            margin: 5px; 
        }
        .error {
            border: 2px solid red;
        }
    </style>
</head>
<body>
		<!--header section-->
        <header>
            <img src="logocct.jpg" style="width:100px; height:80px" alt="Company Logo" />
            <div class="company-name">
                <h2>CCT Stone Solutions</h2> 
                <h4>Karimnagar</h4>
            </div>
        </header>
        <!--navbar section-->
        <div class="navbar-section">
            <ul class="nav justify-content-center">
                <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
                <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
                <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
                <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
                <li class="nav-item"><a class="nav-link" href="slabsReport.html">Slabs Report</a></li>
                <li class="nav-item"><a class="nav-link" href="graphReport.html">Graph Report</a></li>
            </ul>
        </div>    
    <div class="container">
        <h1>STAGE-2. Blocks Dressing/Wiresaw Cutting</h1>
        <form id="inventoryForm">
            
            <button type="button" class="accordion">General Information</button>
            <div class="panel">
                <table>
                    <tr><th>Date of Marking</th><td><label id="date_of_marking" >2025-03-04</label></td></tr>
                    <tr><th>Block Recd Date</th><td><label id="block_recd_date" >2025-03-14</label></td></tr>
                    <tr><th>Block Cutting Date</th><td><input type="date" name="block_cutting_date" id="block_cutting_date" required></td></tr>
                    <tr><th>Block No.</th><td><label id="block_no" >9503</label></td></tr>
                    <tr><th>Block Colour</th><td><label id="block_colour" >PSR - TB</label></td></tr>
                    <tr><th>Net Qty</th><td><label id="net_qty" >5.13</label></td></tr>
                </table>
            </div>
            
            <button type="button" class="accordion">Net Measurement (Marking Qty.)</button>
            <div class="panel">
                <table>
                    <tr><th>Part</th><th>Length</th><th>Height</th><th>Width</th><th>Total</th></tr>
                    <tr><td>A Part</td><td><input type="number" step="0.01" name="a_length" id="a_length" required></td><td><input type="number" step="0.01" name="a_height" id="a_height" required></td><td><input type="number" step="0.01" name="a_width" id="a_width" required></td><td><input type="number" step="0.01" name="a_total" id="a_total" required></td></tr>
                    <tr><td>B Part</td><td><input type="number" step="0.01" name="b_length" id="b_length"></td><td><input type="number" step="0.01" name="b_height" id="b_height"></td><td><input type="number" step="0.01" name="b_width" id="b_width"></td><td><input type="number" step="0.01" name="b_total" id="b_total"></td></tr>
                    <tr><td>C Part</td><td><input type="number" step="0.01" name="c_length" id="c_length"></td><td><input type="number" step="0.01" name="c_height" id="c_height"></td><td><input type="number" step="0.01" name="c_width" id="c_width"></td><td><input type="number" step="0.01" name="c_total" id="c_total"></td></tr>
                    <tr><td>Total</td><td colspan="4"><input type="number" step="0.01" name="total" id="total" required></td></tr>
                    <tr><th  style="background-color: #FFC2D0;">Normal Loss</th><td colspan="4"><input style="background-color: #FFC2D0;" type="number" step="0.01" name="normal_loss" id="normal_loss"></td></tr>
                </table>
            </div>
            
            <button type="button" class="accordion">Incharge Information</button>
            <div class="panel">
                <table>
                    <tr><th>Operator Name</th><td><input type="text" name="operator_name" id="operator_name" required></td></tr>
                    <tr><th>Tekedar Name</th><td><input type="text" name="tekedar_name" id="tekedar_name" required></td></tr>
                </table>
            </div>
            
            <br>
            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="submit" style="display: none" id="backButton">Back</button>
				<button type="submit" class="submit" style="display: block" id="saveButton">Save</button>
				<button type="submit" class="submit" style="width: 200px; display: none" id="moveToProductionButton">Move to Production</button>
            </div>
        </form>
    </div>

    <script>
	document.addEventListener("DOMContentLoaded", function () {
		const urlParams = new URLSearchParams(window.location.search);
            const block_id = urlParams.get("block_id");

            // Fetch block details if block_id is present
            if (block_id) {
				document.querySelectorAll(".submit").forEach(button => {
                button.style.display = "inline-block"; // Make all submit buttons visible
            });
                fetchBlockDetails(block_id);
            }
		var acc = document.getElementsByClassName("accordion");
		for (var i = 0; i < acc.length; i++) {
			acc[i].addEventListener("click", function() {
				this.classList.toggle("active");
				var panel = this.nextElementSibling;
				panel.style.display = (panel.style.display === "block") ? "none" : "block";
			});
		}
		
		document.querySelectorAll('input[type="number"]').forEach(input => {
			input.addEventListener("input", function() {
				let part = this.id.split("_")[0];
				if (["a", "b", "c"].includes(part)) {
					calculateTotal(part);
				}
			});
		});
	});
	
	 // Event listener for the Save Button
	document.getElementById("saveButton").addEventListener("click", function (event) {
		event.preventDefault(); // Prevent default form submission
		
		 let isValid = true;

        this.querySelectorAll('input[required]').forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add("error");
            } else {
                input.classList.remove("error");
            }
        });

        if (isValid) {
            submitForm();
            //alert("Submit form has got triggered!");
        } else {
            alert("Please fill all required fields.");
        }
	});
	
	 // Event listener for the Back button
		document.getElementById("backButton").addEventListener("click", function (event) {
			event.preventDefault(); // Prevent default form submission
			window.history.back(); // Navigate to the previous page
		});
		
	 // Event listener for the Move to Production button
		document.getElementById("moveToProductionButton").addEventListener("click", function (event) {
			event.preventDefault(); // Prevent default form submission

			const urlParams = new URLSearchParams(window.location.search);
			const block_id = urlParams.get("block_id");

			if (block_id) {
				// Redirect to stageTwo.html with the block_id parameter
				window.location.href = `stageThree.html?block_id=${block_id}`;
			} else {
				alert("No block ID found. Please save the record first.");
			}
		});
	
	// Fetch block details from the API
        function fetchBlockDetails(blockId) {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${blockId}`);
            xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    populateForm(data);
                }
            };

            xhr.send();
        }

        // Populate form fields with fetched data
        function populateForm(data) {
            document.getElementById("date_of_marking").textContent = data.date_of_marking || "";
            document.getElementById("block_recd_date").textContent = data.recd_date || "";
            document.getElementById("block_no").textContent = data.id || "";
            document.getElementById("block_colour").textContent = data.blocks?.block_color || "";
            document.getElementById("net_qty").textContent = data.blocks?.net_measurement_qty || "";

            if (data.dressing) {
                document.getElementById("block_cutting_date").value = data.dressing.block_cutting_date || "";
                document.getElementById("a_length").value = data.dressing.part_a?.a_length || "";
                document.getElementById("a_height").value = data.dressing.part_a?.a_height || "";
                document.getElementById("a_width").value = data.dressing.part_a?.a_width || "";
                document.getElementById("a_total").value = data.dressing.part_a?.a_total || "";
                document.getElementById("b_length").value = data.dressing.part_b?.b_length || "";
                document.getElementById("b_height").value = data.dressing.part_b?.b_height || "";
                document.getElementById("b_width").value = data.dressing.part_b?.b_width || "";
                document.getElementById("b_total").value = data.dressing.part_b?.b_total || "";
                document.getElementById("c_length").value = data.dressing.part_c?.c_length || "";
                document.getElementById("c_height").value = data.dressing.part_c?.c_height || "";
                document.getElementById("c_width").value = data.dressing.part_c?.c_width || "";
                document.getElementById("c_total").value = data.dressing.part_c?.c_total || "";
                document.getElementById("total").value = data.dressing.total_parts_qty || "";
                document.getElementById("normal_loss").value = data.dressing.total_parts_normal_loss || "";
                document.getElementById("operator_name").value = data.dressing.operator_name || "";
                document.getElementById("tekedar_name").value = data.dressing.tekedar_name || "";
            }
        }
	
    function calculateTotal(part) {
        let length = parseFloat(document.getElementById(`${part}_length`).value) || 0;
        let height = parseFloat(document.getElementById(`${part}_height`).value) || 0;
        let width = parseFloat(document.getElementById(`${part}_width`).value) || 0;
        let total = length * height * width / 1000000;
        document.getElementById(`${part}_total`).value = total.toFixed(2);
        calculateOverallTotal();
    }

    function calculateOverallTotal() {
        let totalA = parseFloat(document.getElementById("a_total").value) || 0;
        let totalB = parseFloat(document.getElementById("b_total").value) || 0;
        let totalC = parseFloat(document.getElementById("c_total").value) || 0;
        let grandTotal = totalA + totalB + totalC;
        document.getElementById("total").value = grandTotal.toFixed(2);
        let netQty = parseFloat(document.getElementById("net_qty").textContent);
        let normalLoss = netQty - grandTotal;
        document.getElementById("normal_loss").value = normalLoss.toFixed(2);
    }

    function submitForm() {
		const urlParams = new URLSearchParams(window.location.search);
        const block_id = urlParams.get("block_id"); // Replace with actual record ID
		
		var xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
				if (xhr.status === 200) {
					let existingData = JSON.parse(xhr.responseText);
					updateRecord(existingData, block_id);
				} else if (xhr.status === 404) {
					alert("Error: Record not found. Please check the record ID.");
				} else {
					alert("Error fetching existing data. Status: " + xhr.status);
				}
			}
		};

		xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${block_id}`);
		xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
		xhr.send();
    }
	function updateRecord(existingData, block_id) {
			let existingPart = existingData || {}; 
			let updatedDressing = {
				block_cutting_date: getValue("block_cutting_date"),
				part_a: {
				  stage: "2",
				  a_length: getValue("a_length"),
				  a_height: getValue("a_height"),
				  a_width: getValue("a_width"),
				  a_total: getValue("a_total")
				},
				part_b: {
				  stage: "2",
				  b_length: getValue("b_length"),
				  b_height: getValue("b_height"),
				  b_width: getValue("b_width"),
				  b_total: getValue("b_total")
				},
				part_c: {
				  stage: "2",
				  c_length: getValue("c_length"),
				  c_height: getValue("c_height"),
				  c_width: getValue("c_width"),
				  c_total: getValue("c_total")
				},
				total_parts_qty: getValue("total"),
				total_parts_normal_loss: getValue("normal_loss"),
				operator_name: getValue("operator_name"),
				tekedar_name: getValue("tekedar_name")
			};

			let updatedData = {
				...existingPart, 
				dressing: updatedDressing 
			};

			var Xhr = new XMLHttpRequest();
			Xhr.onreadystatechange = function () {
				if (Xhr.readyState === 4) {
					if (Xhr.status === 200 || Xhr.status === 201) {
						alert("Stage-2 data updated successfully!");
					} else {
						alert("Error updating Stage-2 data. Status: " + Xhr.status);
					}
				}
			};

			Xhr.open("PATCH", `https://shivadb-f348.restdb.io/rest/plm-products-db/${block_id}`);
			Xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
			Xhr.setRequestHeader("Content-Type", "application/json");
			Xhr.send(JSON.stringify(updatedData));
		}

	
	function getValue(id) {
		return document.getElementById(id)?.value || "";
	}
	
</script>
</body>
</html>
