<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Graph Report</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid white;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        header .company-name {
            text-align: center;
            color: #E6E6FA;
        }
        header .company-name h2 {
            font-family: Arial, sans-serif;
            font-size: 40px;
            font-weight: 900;
            font-style: italic;
            margin-bottom: 10px;
        }
        header .company-name h4 {
            font-family: Arial, sans-serif;
            font-size: 25px;
            font-weight: bold;
            font-style: italic;
            margin: 0;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 25px 0 0 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            margin-bottom: 20px;
        }
        .nav-link {
            color: white !important;
            font-size: 22px;
            padding: 12px 25px;
        }
        .nav-item {
            list-style: none;
            display: inline-block;
            margin-right: 20px;
        }
        .navbar-section a:hover {
            background-color:  #7fb3d5 ;
            color: black !important;
            border-radius: 5px;
        }
        .container {
            width: 90%;
            margin-top: 60px;
            text-align: center;
        }
        .form-section {
            background-color: #aed6f1;
            padding: 20px;
            width: 50%;
            border-radius: 8px;
            border: 1px solid #1b4f72;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 25%;
            margin-right: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            margin-right: 10px;
            color: #1b4f72;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
            width: 200px;
        }
        .btn {
            padding: 8px 20px;
            font-size: 16px;
            border-radius: 4px;
            margin: 0 10px;
            background-color: #1b4f72;
            color:white;
            border:1px solid #1b4f72 ;
        }
        .btn:hover{
            background-color: #5fa9d1;
            border:1px solid #1b4f72 ;
            font-size: 16px;
        }
        h1 {
            font-weight: bold;
            font-size: 30px;
            text-align: center;
            margin-bottom: 20px;
            color: #1b4f72;
        }
        .chart-wrapper {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            background-color: #d6eaf8;
            border:1px solid #1b4f72 ;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            margin: 20px 0;
            font-size: 18px;
            color: #1b4f72;
        }
        .spinner {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .no-data {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6c757d;
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .chart-wrapper {
                max-width: 100%;
            }
            input, select {
                width: 100%;
                margin-bottom: 10px;
            }
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            header .company-name h2 {
                font-size: 28px;
            }
            header .company-name h4 {
                font-size: 18px;
            }
            .nav-link {
                font-size: 16px;
                padding: 8px 12px;
            }
            .form-section {
                width: 90%;
                margin-left: 5%;
            }
        }
    </style>
  </head>
  <body>
    <header>
      <img src="logocct.jpg" style="width:100px ;height:80px" alt="Company Logo" />
      <div class="company-name">
        <h2>CCT Stone Solutions</h2> 
        <h4>Karimnagar</h4>
      </div>
    </header>

    <!-- Navbar Section -->
    <div class="navbar-section">
        <ul class="nav justify-content-center">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
            <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
            <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
            <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
            <li class="nav-item"><a class="nav-link" href="slabsReport.html">Slabs Report</a></li>
            <li class="nav-item"><a class="nav-link" href="graphReport.html">Graph Report</a></li>
        </ul>
    </div>

    <div class="container">
        <h1>Graph Report</h1>
        
        <div class="form-section">
            <div class="form-group">
                <label for="blockNumber">Block Number:</label>
                <input type="text" id="blockNumber" name="blockNumber" placeholder="Enter block number">
            </div>
            
            <div class="form-group" style="padding-left:15px">
                <label for="part">Choose Part:</label>
                <select name="part" id="part">
                    <option value="">All Parts</option>
                    <option value="part_a">Part-A</option>
                    <option value="part_b">Part-B</option>
                    <option value="part_c">Part-C</option>
                </select>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn" id="submitBtn">
                    <i class="fas fa-chart-bar"></i> Generate Report
                </button>
                <button type="reset" class="btn" id="resetBtn">
                    <i class="fas fa-redo"></i> Clear
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <i class="fas fa-spinner spinner"></i> Loading data, please wait...
        </div>

        <!-- Chart Container -->
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="combinedChart"></canvas>
                <div class="no-data" id="noData">Please enter a block number and click "Generate Report" to view data</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize chart
        let combinedChart;

        function initializeChart() {
            const ctx = document.getElementById('combinedChart').getContext('2d');
            combinedChart = new Chart(ctx, {
                type: "bar",
                plugins: [ChartDataLabels],
                data: {
                    labels: ["Fresh", "Semi-Fresh", "Commercial"],
                    datasets: [
                        {
                            label: "Total Stock (sft)",
                            data: [],
                            backgroundColor: "#3498db",
                            borderColor: "#2980b9",
                            borderWidth: 1,
                            datalabels: {
                                display: true,
                                color: '#000',
                                anchor: 'end',
                                align: 'top',
                                formatter: function(value, context) {
                                    const pcsValue = context.chart.data.datasets[3].data[context.dataIndex];
                                    return `${value.toLocaleString()} (${pcsValue.toLocaleString()} pcs)`;
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        {
                            label: "Sold Stock (sft)",
                            data: [],
                            backgroundColor: "#2ecc71",
                            borderColor: "#27ae60",
                            borderWidth: 1,
                            datalabels: {
                                display: true,
                                color: '#000',
                                anchor: 'end',
                                align: 'top',
                                formatter: function(value, context) {
                                    const pcsValue = context.chart.data.datasets[4].data[context.dataIndex];
                                    return `${value.toLocaleString()} (${pcsValue.toLocaleString()} pcs)`;
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        {
                            label: "Closing Stock (sft)",
                            data: [],
                            backgroundColor: "#f39c12",
                            borderColor: "#d35400",
                            borderWidth: 1,
                            datalabels: {
                                display: true,
                                color: '#000',
                                anchor: 'end',
                                align: 'top',
                                formatter: function(value, context) {
                                    const pcsValue = context.chart.data.datasets[5].data[context.dataIndex];
                                    return `${value.toLocaleString()} (${pcsValue.toLocaleString()} pcs)`;
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        {
                            label: "Total Stock (pcs)",
                            data: [],
                            backgroundColor: "#3498db",
                            borderColor: "#2980b9",
                            borderWidth: 1,
                            hidden: true // Hide the pcs datasets as we're showing them in brackets
                        },
                        {
                            label: "Sold Stock (pcs)",
                            data: [],
                            backgroundColor: "#2ecc71",
                            borderColor: "#27ae60",
                            borderWidth: 1,
                            hidden: true
                        },
                        {
                            label: "Closing Stock (pcs)",
                            data: [],
                            backgroundColor: "#f39c12",
                            borderColor: "#d35400",
                            borderWidth: 1,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "top",
                            labels: {
                                font: {
                                    size: 14
                                },
                                filter: function(item, chart) {
                                    // Only show sft in legend (datasets 0-2)
                                    return item.datasetIndex < 3;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Stock Overview (Square Feet with Piece Count in Brackets)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex < 3) {
                                        // For sft datasets, show both sft and pcs in tooltip
                                        const pcsValue = context.chart.data.datasets[context.datasetIndex + 3].data[context.dataIndex];
                                        label += `${context.parsed.y.toLocaleString()} sft (${pcsValue.toLocaleString()} pcs)`;
                                    } else {
                                        // For pcs datasets (shouldn't show in tooltip as they're hidden)
                                        label += `${context.parsed.y.toLocaleString()} pcs`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Square Feet (sft)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
            
            // Hide chart initially
            document.getElementById('combinedChart').style.display = 'none';
        }

        // Function to fetch data from API
        async function fetchBlockData(blockNumber, part) {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            
            try {
                const response = await fetch(`https://shivadb-f348.restdb.io/rest/plm-products-db?q={"id":"${blockNumber}"}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '657c53fe63ede92cdbf17208'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                loadingElement.style.display = 'none';
                
                if (data.length === 0) {
                    alert(`No data found for block number: ${blockNumber}`);
                    return null;
                }
                
                return data[0]; // Return the first (and presumably only) block data
            } catch (error) {
                loadingElement.style.display = 'none';
                console.error('Error fetching data:', error);
                alert(`Error fetching data for block ${blockNumber}. Please try again.`);
                return null;
            }
        }

        // Function to update chart with new data
        function updateChart(blockData, selectedPart) {
            let partsToShow = [];
            
            if (selectedPart) {
                partsToShow = [selectedPart];
            } else {
                partsToShow = ['part_a', 'part_b', 'part_c'];
            }
            
            // Initialize totals for both sft and pcs
            const totalsSft = {
                fresh: { total: 0, sold: 0, closing: 0 },
                semi_fresh: { total: 0, sold: 0, closing: 0 },
                commercial: { total: 0, sold: 0, closing: 0 }
            };
            
            const totalsPcs = {
                fresh: { total: 0, sold: 0, closing: 0 },
                semi_fresh: { total: 0, sold: 0, closing: 0 },
                commercial: { total: 0, sold: 0, closing: 0 }
            };
            
            // Process each part
            partsToShow.forEach(part => {
                if (blockData.dressing && blockData.dressing[part]) {
                    const partData = blockData.dressing[part];
                    
                    // Marking and Sales data
                    if (partData.marking_sales_particulars) {
                        // Square feet data
                        totalsSft.fresh.total += parseFloat(partData.marking_sales_particulars.fresh.fresh_sft) || 0;
                        totalsSft.semi_fresh.total += parseFloat(partData.marking_sales_particulars.semi_fresh.semi_fresh_sft) || 0;
                        totalsSft.commercial.total += parseFloat(partData.marking_sales_particulars.commercial.commercial_sft) || 0;
                        
                        // Piece count data
                        totalsPcs.fresh.total += parseInt(partData.marking_sales_particulars.fresh.fresh_pcs) || 0;
                        totalsPcs.semi_fresh.total += parseInt(partData.marking_sales_particulars.semi_fresh.semi_fresh_pcs) || 0;
                        totalsPcs.commercial.total += parseInt(partData.marking_sales_particulars.commercial.commercial_pcs) || 0;
                    }
                    
                    // Sales data
                    if (partData.sales_report) {
                        // Square feet data
                        totalsSft.fresh.sold += parseFloat(partData.sales_report.fresh.sale_fresh_sft) || 0;
                        totalsSft.semi_fresh.sold += parseFloat(partData.sales_report.semi_fresh.sale_semi_fresh_sft) || 0;
                        totalsSft.commercial.sold += parseFloat(partData.sales_report.commercial.sale_commercial_sft) || 0;
                        
                        // Piece count data
                        totalsPcs.fresh.sold += parseInt(partData.sales_report.fresh.sale_fresh_pcs) || 0;
                        totalsPcs.semi_fresh.sold += parseInt(partData.sales_report.semi_fresh.sale_semi_fresh_pcs) || 0;
                        totalsPcs.commercial.sold += parseInt(partData.sales_report.commercial.sale_commercial_pcs) || 0;
                        
                        // Closing stock after sale
                        if (partData.sales_report.closing_stock_after_sale) {
                            // Square feet data
                            totalsSft.fresh.closing += parseFloat(partData.sales_report.closing_stock_after_sale.fresh.closing_fresh_sft) || 0;
                            totalsSft.semi_fresh.closing += parseFloat(partData.sales_report.closing_stock_after_sale.semi_fresh.closing_semi_fresh_sft) || 0;
                            totalsSft.commercial.closing += parseFloat(partData.sales_report.closing_stock_after_sale.commercial.closing_commercial_sft) || 0;
                            
                            // Piece count data
                            totalsPcs.fresh.closing += parseInt(partData.sales_report.closing_stock_after_sale.fresh.closing_fresh_pcs) || 0;
                            totalsPcs.semi_fresh.closing += parseInt(partData.sales_report.closing_stock_after_sale.semi_fresh.closing_semi_fresh_pcs) || 0;
                            totalsPcs.commercial.closing += parseInt(partData.sales_report.closing_stock_after_sale.commercial.closing_commercial_pcs) || 0;
                        }
                    }
                }
            });
            
            // Show chart and hide "no data" message
            document.getElementById('combinedChart').style.display = 'block';
            document.getElementById('noData').style.display = 'none';
            
            // Update Square Feet chart data (datasets 0-2)
            combinedChart.data.datasets[0].data = [
                totalsSft.fresh.total,
                totalsSft.semi_fresh.total,
                totalsSft.commercial.total
            ];
            
            combinedChart.data.datasets[1].data = [
                totalsSft.fresh.sold,
                totalsSft.semi_fresh.sold,
                totalsSft.commercial.sold
            ];
            
            combinedChart.data.datasets[2].data = [
                totalsSft.fresh.closing,
                totalsSft.semi_fresh.closing,
                totalsSft.commercial.closing
            ];
            
            // Update Piece Count chart data (datasets 3-5)
            combinedChart.data.datasets[3].data = [
                totalsPcs.fresh.total,
                totalsPcs.semi_fresh.total,
                totalsPcs.commercial.total
            ];
            
            combinedChart.data.datasets[4].data = [
                totalsPcs.fresh.sold,
                totalsPcs.semi_fresh.sold,
                totalsPcs.commercial.sold
            ];
            
            combinedChart.data.datasets[5].data = [
                totalsPcs.fresh.closing,
                totalsPcs.semi_fresh.closing,
                totalsPcs.commercial.closing
            ];
            
            // Update chart title based on selection
            let chartTitleSuffix = selectedPart ? ` (${selectedPart.replace('_', '-').toUpperCase()})` : ' (All Parts)';
            combinedChart.options.plugins.title.text = `Stock Overview - Square Feet with Piece Count${chartTitleSuffix}`;
            
            combinedChart.update();
        }

        // Reset form and chart
        function resetForm() {
            document.getElementById('blockNumber').value = '';
            document.getElementById('part').value = '';
            
            // Hide chart and show "no data" message
            document.getElementById('combinedChart').style.display = 'none';
            document.getElementById('noData').style.display = 'flex';
        }

        // Initialize chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            
            // Add click event to submit button
            document.getElementById('submitBtn').addEventListener('click', async function() {
                const blockNumber = document.getElementById('blockNumber').value.trim();
                const part = document.getElementById('part').value;
                
                if (!blockNumber) {
                    alert('Please enter a block number');
                    return;
                }
                
                const blockData = await fetchBlockData(blockNumber, part);
                if (blockData) {
                    updateChart(blockData, part);
                }
            });
            
            // Add click event to reset button
            document.getElementById('resetBtn').addEventListener('click', function() {
                resetForm();
            });
        });
    </script>
  </body>
</html>