<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Graphreport</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <style>
        body {
            font-family: Arial, sans-serif;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 15px 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
        }
        .nav-link {
            color: white !important;
            font-size: 18px;
            padding: 10px 20px;
        }
        .container {
            width: 90%;
            margin: auto;
            text-align: center;
        }
        .charts-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .chart-wrapper {
            width: 100%;
            max-width: 800px;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
  </head>
  <body>
    <header>
      <img src="logocct.jpg" style="width:100px ;height:80px" alt="Company Logo" />
      <div class="company-name">
        <h2>CCT Stonexa</h2> 
        <h4>Karimnagar</h4>
      </div>
    </header>

    <!-- Navbar Section -->
    <div class="navbar-section">
        <ul class="nav justify-content-center">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
            <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
            <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
            <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
            <li class="nav-item"><a class="nav-link" href="slabsReport.html">Slabs Report</a></li>
            <li class="nav-item"><a class="nav-link" href="graphReport.html">Graph Report</a></li>
        </ul>
    </div>

    <div class="container">
        <h1>Graph Report</h1>
        <label for="blockNumber">Block Number: </label>
        <input type="text" id="blockNumber" name="blockNumber"><br><br>
        <label for="part">Choose Part: </label>
        <select name="part" id="part">
            <option value="">All Parts</option>
            <option value="part_a">Part-A</option>
            <option value="part_b">Part-B</option>
            <option value="part_c">Part-C</option>
        </select><br>
        <input type="submit" value="Submit" class="submit" id="submitBtn">
        <div class="loading" id="loading">Loading data...</div>

        <!-- Charts Container -->
        <div class="charts-row">
            <div class="chart-wrapper">
                <div class="chart-container">
                    <canvas id="stockChartSft"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <div class="chart-container">
                    <canvas id="stockChartPcs"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize charts with empty data
        let stockChartSft, stockChartPcs;

        function initializeCharts() {
            // Square Feet Chart
            const ctxSft = document.getElementById('stockChartSft').getContext('2d');
            stockChartSft = new Chart(ctxSft, {
                type: "bar",
                data: {
                    labels: ["Fresh", "Semi-Fresh", "Commercial"],
                    datasets: [
                        {
                            label: "Total Stock (sft)",
                            data: [0, 0, 0],
                            backgroundColor: "#8884d8"
                        },
                        {
                            label: "Sold Stock (sft)",
                            data: [0, 0, 0],
                            backgroundColor: "#82ca9d"
                        },
                        {
                            label: "Closing Stock (sft)",
                            data: [0, 0, 0],
                            backgroundColor: "#ffc658"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "top"
                        },
                        title: {
                            display: true,
                            text: 'Stock Overview (Square Feet)',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Square Feet (sft)'
                            }
                        }
                    }
                }
            });

            // Piece Count Chart
            const ctxPcs = document.getElementById('stockChartPcs').getContext('2d');
            stockChartPcs = new Chart(ctxPcs, {
                type: "bar",
                data: {
                    labels: ["Fresh", "Semi-Fresh", "Commercial"],
                    datasets: [
                        {
                            label: "Total Stock (pcs)",
                            data: [0, 0, 0],
                            backgroundColor: "#8884d8"
                        },
                        {
                            label: "Sold Stock (pcs)",
                            data: [0, 0, 0],
                            backgroundColor: "#82ca9d"
                        },
                        {
                            label: "Closing Stock (pcs)",
                            data: [0, 0, 0],
                            backgroundColor: "#ffc658"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "top"
                        },
                        title: {
                            display: true,
                            text: 'Stock Overview (Piece Count)',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Pieces'
                            }
                        }
                    }
                }
            });
        }

        // Function to fetch data from API
        async function fetchBlockData(blockNumber, part) {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            
            try {
                const response = await fetch(`https://shivadb-f348.restdb.io/rest/plm-products-db?q={"id":"${blockNumber}"}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '657c53fe63ede92cdbf17208'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                loadingElement.style.display = 'none';
                
                if (data.length === 0) {
                    alert('No data found for the specified block number');
                    return null;
                }
                
                return data[0]; // Return the first (and presumably only) block data
            } catch (error) {
                loadingElement.style.display = 'none';
                console.error('Error fetching data:', error);
                alert('Error fetching data. Please check console for details.');
                return null;
            }
        }

        // Function to update charts with new data
        function updateCharts(blockData, selectedPart) {
            let partsToShow = [];
            
            if (selectedPart) {
                partsToShow = [selectedPart];
            } else {
                partsToShow = ['part_a', 'part_b', 'part_c'];
            }
            
            // Initialize totals for both sft and pcs
            const totalsSft = {
                fresh: { total: 0, sold: 0, closing: 0 },
                semi_fresh: { total: 0, sold: 0, closing: 0 },
                commercial: { total: 0, sold: 0, closing: 0 }
            };
            
            const totalsPcs = {
                fresh: { total: 0, sold: 0, closing: 0 },
                semi_fresh: { total: 0, sold: 0, closing: 0 },
                commercial: { total: 0, sold: 0, closing: 0 }
            };
            
            // Process each part
            partsToShow.forEach(part => {
                if (blockData.dressing && blockData.dressing[part]) {
                    const partData = blockData.dressing[part];
                    
                    // Marking and Sales data
                    if (partData.marking_sales_particulars) {
                        // Square feet data
                        totalsSft.fresh.total += parseFloat(partData.marking_sales_particulars.fresh.fresh_sft) || 0;
                        totalsSft.semi_fresh.total += parseFloat(partData.marking_sales_particulars.semi_fresh.semi_fresh_sft) || 0;
                        totalsSft.commercial.total += parseFloat(partData.marking_sales_particulars.commercial.commercial_sft) || 0;
                        
                        // Piece count data
                        totalsPcs.fresh.total += parseInt(partData.marking_sales_particulars.fresh.fresh_pcs) || 0;
                        totalsPcs.semi_fresh.total += parseInt(partData.marking_sales_particulars.semi_fresh.semi_fresh_pcs) || 0;
                        totalsPcs.commercial.total += parseInt(partData.marking_sales_particulars.commercial.commercial_pcs) || 0;
                    }
                    
                    // Sales data
                    if (partData.sales_report) {
                        // Square feet data
                        totalsSft.fresh.sold += parseFloat(partData.sales_report.fresh.sale_fresh_sft) || 0;
                        totalsSft.semi_fresh.sold += parseFloat(partData.sales_report.semi_fresh.sale_semi_fresh_sft) || 0;
                        totalsSft.commercial.sold += parseFloat(partData.sales_report.commercial.sale_commercial_sft) || 0;
                        
                        // Piece count data
                        totalsPcs.fresh.sold += parseInt(partData.sales_report.fresh.sale_fresh_pcs) || 0;
                        totalsPcs.semi_fresh.sold += parseInt(partData.sales_report.semi_fresh.sale_semi_fresh_pcs) || 0;
                        totalsPcs.commercial.sold += parseInt(partData.sales_report.commercial.sale_commercial_pcs) || 0;
                        
                        // Closing stock after sale
                        if (partData.sales_report.closing_stock_after_sale) {
                            // Square feet data
                            totalsSft.fresh.closing += parseFloat(partData.sales_report.closing_stock_after_sale.fresh.closing_fresh_sft) || 0;
                            totalsSft.semi_fresh.closing += parseFloat(partData.sales_report.closing_stock_after_sale.semi_fresh.closing_semi_fresh_sft) || 0;
                            totalsSft.commercial.closing += parseFloat(partData.sales_report.closing_stock_after_sale.commercial.closing_commercial_sft) || 0;
                            
                            // Piece count data
                            totalsPcs.fresh.closing += parseInt(partData.sales_report.closing_stock_after_sale.fresh.closing_fresh_pcs) || 0;
                            totalsPcs.semi_fresh.closing += parseInt(partData.sales_report.closing_stock_after_sale.semi_fresh.closing_semi_fresh_pcs) || 0;
                            totalsPcs.commercial.closing += parseInt(partData.sales_report.closing_stock_after_sale.commercial.closing_commercial_pcs) || 0;
                        }
                    }
                }
            });
            
            // Update Square Feet chart data
            stockChartSft.data.datasets[0].data = [
                totalsSft.fresh.total,
                totalsSft.semi_fresh.total,
                totalsSft.commercial.total
            ];
            
            stockChartSft.data.datasets[1].data = [
                totalsSft.fresh.sold,
                totalsSft.semi_fresh.sold,
                totalsSft.commercial.sold
            ];
            
            stockChartSft.data.datasets[2].data = [
                totalsSft.fresh.closing,
                totalsSft.semi_fresh.closing,
                totalsSft.commercial.closing
            ];
            
            // Update Piece Count chart data
            stockChartPcs.data.datasets[0].data = [
                totalsPcs.fresh.total,
                totalsPcs.semi_fresh.total,
                totalsPcs.commercial.total
            ];
            
            stockChartPcs.data.datasets[1].data = [
                totalsPcs.fresh.sold,
                totalsPcs.semi_fresh.sold,
                totalsPcs.commercial.sold
            ];
            
            stockChartPcs.data.datasets[2].data = [
                totalsPcs.fresh.closing,
                totalsPcs.semi_fresh.closing,
                totalsPcs.commercial.closing
            ];
            
            // Update chart titles based on selection
            let chartTitleSuffix = selectedPart ? ` (${selectedPart.replace('_', '-').toUpperCase()})` : ' (All Parts)';
            
            stockChartSft.options.plugins.title.text = `Stock Overview - Square Feet${chartTitleSuffix}`;
            stockChartPcs.options.plugins.title.text = `Stock Overview - Piece Count${chartTitleSuffix}`;
            
            stockChartSft.update();
            stockChartPcs.update();
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Add click event to submit button
            document.getElementById('submitBtn').addEventListener('click', async function() {
                const blockNumber = document.getElementById('blockNumber').value.trim();
                const part = document.getElementById('part').value;
                
                if (!blockNumber) {
                    alert('Please enter a block number');
                    return;
                }
                
                const blockData = await fetchBlockData(blockNumber, part);
                if (blockData) {
                    updateCharts(blockData, part);
                }
            });
        });
    </script>
  </body>
</html>