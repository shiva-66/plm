<!DOCTYPE html>
<html>
<head>
    <title>Granite Inventory Input</title>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
         body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 140px;
            background-color: #d6eaf8 !important;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1b4f72;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid white;
        }
        header img {
            margin-right: 35px;
            border-radius: 50px;
        }
        header .company-name {
            text-align: center;
            color: #E6E6FA;
        }
        header .company-name h2 {
            font-family: Arial, sans-serif;
            font-size: 40px;
            font-weight: 900;
            font-style: italic;
            margin-bottom: 10px;
        }
        header .company-name h4 {
            font-family: Arial, sans-serif;
            font-size: 25px;
            font-weight: bold;
            font-style: italic;
            margin: 0;
        }
        .navbar-section {
            background-color: #1b4f72;
            padding: 25px 0 0 0;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            margin-bottom: 20px;
        }
        .nav-link {
            color: white !important;
            font-size: 22px;
            padding: 12px 25px;
        }
        .nav-item {
            list-style: none;
            display: inline-block;
            margin-right: 20px;
        }
        .navbar-section a:hover {
            background-color:  #7fb3d5 ;
            color: black !important;
            border-radius: 5px;
        }
        .container {
           width: 80%;
           margin-top: 60px;
           text-align: center;
        }
		h1{
			font-weight: bold; 
			font-size: 30px; 
			text-align: center; 
			margin-bottom: 20px;color:#1b4f72;
		}
        .accordion {
            background-color: #7fb3d5 ;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: 0.4s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .active, .accordion:hover {
            background-color:#1b4f72;
            color:white;
        }
        .panel {
            padding: 10px;
            display: none;
            background-color: white;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse !important;
			background-color: #d6eaf8  ;
        }
        th, td {
            border: 1px solid black !important;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #d6eaf8  ;
        }
        input {
            width: 90%;
            padding: 5px;
			background-color: #F5F5F5;
			border:1px solid black;
        }
        .error {
            color: red;
            font-size: 14px;
        }
		.submit {
            padding: 10px 20px;
            font-size: 18px; 
            background-color: #1b4f72;
            color: white;
            border: none; 
            cursor: pointer; 
            border-radius: 5px;
            width: 15%;  
            display: inline-block; 
            margin: 5px; 
        }

        fieldset {
            padding: 15px;
            border-radius: 8px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
		a {
			color: #1b4f72;
			font-weight: bold;
			text-decoration: none;
		}

		a:hover {
			text-decoration: underline;
			color: #145a8a;
		}
    </style>
	    
</head>
<body>
	<!--header section-->
    <header>
		<img src="logocct.jpg" style="width:100px; height:80px" alt="Company Logo" />
		<div class="company-name">
			<h2>Cloud Chain Technologies</h2> 
			<h4>Karimnagar</h4>
		</div>
	</header>
	<!--navbar section-->
	<div class="navbar-section">
        <ul class="nav justify-content-center">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="stageOne.html">Add Product</a></li>
            <li class="nav-item"><a class="nav-link" href="productList.html">Search & Edit</a></li>
            <li class="nav-item"><a class="nav-link" href="productSale.html">Sell</a></li>
            <li class="nav-item"><a class="nav-link" href="salesreport.html">Sales Report</a></li>
        </ul>
    </div>
	<!--page-->
    <div class="container">
        <h1 style="font-weight: bold; font-size: 30px; text-align: center; margin-bottom: 20px;color:#1b4f72">
			Granite Inventory Input Form
		</h1>
		
        <form id="inventoryForm" novalidate>
            
            <button type="button" class="accordion">Basic Details<span class="arrow">▼</span></button>
            <div class="panel">
                <table>
                    <tr><th style="border: 1px solid black;">Date of Marking</th><td><input type="date" name="date_of_marking" id="date_of_marking" required ></td></tr>
                    <tr><th>Recd Date</th><td><input type="date" name="recd_date" id="recd_date" required></td></tr>
                    <tr><th>Name of the Supplier</th><td><input type="text" name="supplier_name"  id="supplier_name" required></td></tr>
                    <tr><th>Goods Received From Which Quarry</th><td><input type="text" name="quarry_name" id="quarry_name" required></td></tr>
                </table>
            </div>
            
            <button type="button" class="accordion">Block Details<span class="arrow">▼</span></button>
            <div class="panel">
                <table>
                    <tr><th>Block Number</th><td><input type="text" name="block_number" id="block_number" required></td></tr>
                    <tr><th>Block Color</th><td><input type="text" name="block_color" id="block_color" required></td></tr>
                    <tr>
                        <th colspan="2">
                            <fieldset>
                                <legend>Net Measurement</legend>
                                <div class="radio-group">
                                    <label><input type="radio" name="measurement_type" id="measurement_type_cbm" value="cbm" checked onclick="toggleMeasurement('cbm')" required> CBM</label>
                                    <label><input type="radio" name="measurement_type" id="measurement_type_sqft" value="sqft" onclick="toggleMeasurement('sqft')" required> Square Feet</label>
                                </div>
                                
                                <div id="cbmFields">
                                    <table>
                                        <tr><th>Length (m)</th><td><input type="number" name="length" step="0.01" id="length" min="0" required ></td></tr>
                                        <tr><th>Width (m)</th><td><input type="number" name="width"step="0.01" id="width" min="0" required ></td></tr>
                                        <tr><th>Height (m)</th><td><input type="number"name="height" step="0.01" id="height" min="0" required ></td></tr>
                                        <tr><th>Net Measurement (CBM)</th><td><input type="number" name="net_measurement"step="0.01" id="net_qty_cbm" readonly></td></tr>
                                    </table>
                                </div>
                                
                                <div id="sqftFields" style="display: none;">
                                    <table>
                                        <tr><th>Length (ft)</th><td><input type="number" name="length"step="0.01" id="length_ft" min="0" ></td></tr>
                                        <tr><th>Width (ft)</th><td><input type="number"name="width" step="0.01" id="width_ft" min="0" ></td></tr>
                                        <tr><th>Net Measurement (Sq Ft)</th><td><input type="number" name="net_measurement"step="0.01" id="net_qty_sqft" readonly></td></tr>
                                    </table>
                                </div>
                            </fieldset>
                        </th>
                    </tr>
                    <tr><th>No. Of Blocks</th><td><input type="number" name="num_blocks" id="num_blocks" min="1" required></td></tr>
                    <tr><th>No of Trips</th><td><input type="number" name="num_trips" id="num_trips" min="1" required></td></tr>
                    <tr><th>Blocks Weight in each load (Tonnage)</th><td><input type="number" step="0.01" name="weight_tonnage" id="weight_tonnage" min="0" required></td></tr>
                    <tr>
                        <th colspan="2">
                            <fieldset>
                                <legend>Block Purchase Value</legend>
                                <table>
                                    <tr><th>QTY. [250 SFT/CBM] (Sreevaree)</th><td><input type="number" step="0.01" name="qty_sft_cbm" id="qty_sft_cbm" min="0"></td></tr>
                                    <tr><th>Price/ SFT (Sreevaree)</th><td><input type="number" step="0.01" name="price_sft" id="price_sft" min="0"></td></tr>
                                    <tr><th>Price/ CBM (Other Suppliers)</th><td><input type="number" step="0.01" name="price_cbm" id="price_cbm" min="0"></td></tr>
                                    <tr><th>Amount</th><td><input type="number" step="0.01" name="amount" id="amount" min="0" readonly></td></tr>
                                </table>
                            </fieldset>
                        </th>
                    </tr>
                    <tr><th>Gate Pass No</th><td><input type="text" name="gate_pass_no" id="gate_pass_no" required></td></tr>
                </table>
            </div>
            
            <button type="button" class="accordion">Transporter Details<span class="arrow">▼</span></button>
            <div class="panel">
                <table>
                    <tr><th>Transporter Name</th><td><input type="text" name="transporter_name" id="transporter_name" required></td></tr>
                    <tr><th>Driver Name</th><td><input type="text" name="driver_name" id="driver_name" required></td></tr>
                    <tr><th>Vehicle Number</th><td><input type="text" name="vehicle_number" id="vehicle_number" required></td></tr>
                    <tr><th>Transport rate/Tonnage</th><td><input type="text" name="transport_rate" id="transport_rate" required></td></tr>
                    <tr><th>Transport Amount</th><td><input type="number" step="0.01" name="transport_amount" id="transport_amount" required></td></tr>
                </table>
            </div>
            <button type="button" class="accordion">Other Expenses<span class="arrow">▼</span></button>
            <div class="panel">
                <table>
                    <tr><th>Weighting expense</th><td><input type="number" name="weighting_expense" id="weighting_expense" required></td></tr>
                    <tr><th>Loading Mamulu</th><td><input type="number" name="loading_mamulu" id="loading_mamulu" required></td></tr>
                    <tr><th>Total Blocks cost</th><td><input type="number" name="total_blocks_cost" id="total_blocks_cost" required></td></tr>
                </table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="submit" style="display: none" id="backButton">Back</button>
				<button type="submit" class="submit" style="display: block" id="saveButton">Save</button>
				<button type="submit" class="submit" style="width: 200px; display: none" id="moveToDressingButton">Move to Dressing</button>
            </div>
        </form>
    </div>

    <script>
    // Move toggleMeasurement outside of DOMContentLoaded
    function toggleMeasurement(type) {
        document.getElementById('cbmFields').style.display = type === 'cbm' ? 'block' : 'none';
        document.getElementById('sqftFields').style.display = type === 'sqft' ? 'block' : 'none';
    }
	
	document.getElementById("saveButton").addEventListener("click", function (event) {
		event.preventDefault(); // Prevent default form submission
		 let isValid = true;

        this.querySelectorAll('input[required]').forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add("error");
            } else {
                input.classList.remove("error");
            }
        });

        if (isValid) {
            submitForm();
            alert("Submit form has got triggered!");
        } else {
            alert("Please fill all required fields.");
        }
	});

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const block_id = urlParams.get("block_id");
        console.log(block_id);

        // Show all submit buttons if URL parameters are present
        if (block_id) {
            document.querySelectorAll(".submit").forEach(button => {
                button.style.display = "inline-block"; // Make all submit buttons visible
            });
			
            // Fetch block details if block_id is present
            fetchBlockDetails(block_id);
        }
		
		// Disable the block_number field if block_id is present
			if (block_id) {
				document.getElementById("block_number").disabled = true;
			}

        // Accordion functionality
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function () {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                var arrow = this.querySelector(".arrow");

                if (panel.style.display === "block") {
                    panel.style.display = "none";
                    arrow.textContent = "▼";
                } else {
                    panel.style.display = "block";
                    arrow.textContent = "▲";
                }
            });
        }

        // Event listeners for radio buttons
        document.querySelectorAll("input[name='measurement_type']").forEach(radio => {
            radio.addEventListener("change", function () {
                toggleMeasurement(this.value);
            });
        });
		
		  // Event listener for the Back button
		document.getElementById("backButton").addEventListener("click", function (event) {
			event.preventDefault(); // Prevent default form submission
			window.history.back(); // Navigate to the previous page
		});
		
		 // Event listener for the Move to Dressing button
		document.getElementById("moveToDressingButton").addEventListener("click", function (event) {
			event.preventDefault(); // Prevent default form submission

			const urlParams = new URLSearchParams(window.location.search);
			const block_id = urlParams.get("block_id");

			if (block_id) {
				// Redirect to stageTwo.html with the block_id parameter
				window.location.href = `stageTwo.html?block_id=${block_id}`;
			} else {
				alert("No block ID found. Please save the record first.");
			}
		});

        // Event listeners for calculations
        ["length", "width", "height"].forEach(id => document.getElementById(id).addEventListener("input", calculateCBM));
        ["length_ft", "width_ft"].forEach(id => document.getElementById(id).addEventListener("input", calculateSqFt));
        ["price_cbm", "price_sft"].forEach(id => document.getElementById(id).addEventListener("input", calculateAmount));
        ["transport_amount", "weighting_expense", "loading_mamulu"].forEach(id => document.getElementById(id).addEventListener("input", totalBlocksCost));
    });

    // Fetch block details from the API
    function fetchBlockDetails(blockId) {
        fetch(`https://shivadb-f348.restdb.io/rest/plm-products-db/${blockId}`, {
            method: "GET",
            headers: {
                "x-api-key": "657c53fe63ede92cdbf17208",
                "Content-Type": "application/json",
            },
        })
            .then(response => response.json())
            .then(data => populateForm(data))
            .catch(error => console.error("Error fetching block details:", error));
    }

    // Populate form fields with fetched data
    function populateForm(data) {
        document.getElementById("block_number").value = data.id || "";
        document.getElementById("date_of_marking").value = data.date_of_marking || "";
        document.getElementById("recd_date").value = data.recd_date || "";
        document.getElementById("supplier_name").value = data.supplier_name || "";
        document.getElementById("quarry_name").value = data.quarry_name || "";
        document.getElementById("block_color").value = data.blocks?.block_color || "";
        document.getElementById("num_blocks").value = data.blocks?.num_of_blocks || "";
        document.getElementById("num_trips").value = data.blocks?.num_of_trips || "";
        document.getElementById("weight_tonnage").value = data.blocks?.weight_tonnage || "";
        document.getElementById("qty_sft_cbm").value = data.blocks?.qty_sft_cbm || "";
        document.getElementById("price_sft").value = data.blocks?.price_sft || "";
        document.getElementById("price_cbm").value = data.blocks?.price_cbm || "";
        document.getElementById("amount").value = data.blocks?.amount || "";
        document.getElementById("gate_pass_no").value = data.blocks?.gate_pass_no || "";
        document.getElementById("transporter_name").value = data.blocks?.transporter_details?.transporter_name || "";
        document.getElementById("driver_name").value = data.blocks?.transporter_details?.driver_name || "";
        document.getElementById("vehicle_number").value = data.blocks?.transporter_details?.vehicle_number || "";
        document.getElementById("transport_rate").value = data.blocks?.transporter_details?.transport_rate || "";
        document.getElementById("transport_amount").value = data.blocks?.transporter_details?.transport_amount || "";
        document.getElementById("weighting_expense").value = data.blocks?.other_expenses?.weighting_expense || "";
        document.getElementById("loading_mamulu").value = data.blocks?.other_expenses?.loading_mamulu || "";
        document.getElementById("total_blocks_cost").value = data.blocks?.other_expenses?.total_blocks_cost || "";

        // Select Measurement Type
        if (data.blocks?.measurement_type) {
            document.querySelector(`input[name="measurement_type"][value="${data.blocks.measurement_type}"]`).checked = true;
            toggleMeasurement(data.blocks.measurement_type);
        }

        // Populate measurements based on type
        if (data.blocks?.measurement_type === "cbm") {
            document.getElementById("length").value = data.blocks.length || "";
            document.getElementById("width").value = data.blocks.width || "";
            document.getElementById("height").value = data.blocks.height || "";
            document.getElementById("net_qty_cbm").value = data.blocks.net_measurement_qty || "";
        } else {
            document.getElementById("length_ft").value = data.blocks.length || "";
            document.getElementById("width_ft").value = data.blocks.width || "";
            document.getElementById("net_qty_sqft").value = data.blocks.net_measurement_qty || "";
        }
    }

    // Submit form data to the API
    function submitForm() {
        const urlParams = new URLSearchParams(window.location.search);
		const block_id = urlParams.get("block_id");

		const jsonData = JSON.stringify({
			id: getValue("block_number"),
			stage: "1",
			date_of_marking: getValue("date_of_marking"),
			recd_date: getValue("recd_date"),
			supplier_name: getValue("supplier_name"),
			quarry_name: getValue("quarry_name"),
			blocks: {
				block_color: getValue("block_color"),
				measurement_type: document.querySelector('input[name="measurement_type"]:checked').value,
				length: getValue("length") || getValue("length_ft"),
				width: getValue("width") || getValue("width_ft"),
				height: getValue("height") || null,
				net_measurement_qty: getValue("net_qty_cbm") || getValue("net_qty_sqft"),
				num_of_blocks: getValue("num_blocks"),
				num_of_trips: getValue("num_trips"),
				weight_tonnage: getValue("weight_tonnage"),
				qty_sft_cbm: getValue("qty_sft_cbm"),
				price_sft: getValue("price_sft"),
				price_cbm: getValue("price_cbm"),
				amount: getValue("amount"),
				gate_pass_no: getValue("gate_pass_no"),
				transporter_details: {
					transporter_name: getValue("transporter_name"),
					driver_name: getValue("driver_name"),
					vehicle_number: getValue("vehicle_number"),
					transport_rate: getValue("transport_rate"),
					transport_amount: getValue("transport_amount"),
				},
				other_expenses: {
					weighting_expense: getValue("weighting_expense"),
					loading_mamulu: getValue("loading_mamulu"),
					total_blocks_cost: getValue("total_blocks_cost"),
				},
			},
		});

		const submitButton = document.getElementById("saveButton");
		submitButton.disabled = true; // Disable the submit button

		let apiUrl = "https://shivadb-f348.restdb.io/rest/plm-products-db";
		let method = "POST"; // Default to creating a new record

		if (block_id) {
			// If block_id is present, update the existing record
			apiUrl += `/${block_id}`;
			method = "PUT"; // Use PUT to update the record
		}

		const xhr = new XMLHttpRequest();
		xhr.open(method, apiUrl, true);
		xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
		xhr.setRequestHeader("Content-Type", "application/json");

		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
				if (xhr.status === 200 || xhr.status === 201) {
					console.log("Data saved successfully!");
					alert("Data saved successfully!");
					if (!block_id) {
						// If creating a new record, reset the form
						document.getElementById("inventoryForm").reset();
					}
				} else {
					console.error("Error saving data:", xhr.responseText);
					alert("Error saving data. Please try again.");
				}
				submitButton.disabled = false; // Re-enable the submit button
			}
		};

		xhr.send(jsonData);
    }

    // Helper function to get input values
    function getValue(id) {
        return document.getElementById(id).value.trim() || null;
    }

    // Calculate CBM
    function calculateCBM() {
        const length = parseFloat(document.getElementById('length').value) || 0;
        const width = parseFloat(document.getElementById('width').value) || 0;
        const height = parseFloat(document.getElementById('height').value) || 0;
        const cbm = (length * width * height) / 1000000;
        document.getElementById('net_qty_cbm').value = cbm.toFixed(2);
    }

    // Calculate Square Feet
    function calculateSqFt() {
        const length = parseFloat(document.getElementById('length_ft').value) || 0;
        const width = parseFloat(document.getElementById('width_ft').value) || 0;
        const sqft = length * width;
        document.getElementById('net_qty_sqft').value = sqft.toFixed(2);
    }

    // Calculate Amount
    function calculateAmount() {
        const selectedValue = document.querySelector('input[name="measurement_type"]:checked').value;
        let amount;
        if (selectedValue === "cbm") {
            const netQty = parseFloat(document.getElementById('net_qty_cbm').value) || 0;
            const priceCbm = parseFloat(document.getElementById('price_cbm').value) || 0;
            amount = netQty * priceCbm;
        } else {
            const netQty = parseFloat(document.getElementById('net_qty_sqft').value) || 0;
            const priceSqft = parseFloat(document.getElementById('price_sft').value) || 0;
            amount = netQty * priceSqft;
        }
        document.getElementById('amount').value = amount.toFixed(2);
    }

    // Calculate Total Blocks Cost
    function totalBlocksCost() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const transportAmount = parseFloat(document.getElementById('transport_amount').value) || 0;
        const weightingExp = parseFloat(document.getElementById('weighting_expense').value) || 0;
        const loadingMamulu = parseFloat(document.getElementById('loading_mamulu').value) || 0;
        const overallBlocksCost = amount + transportAmount + weightingExp + loadingMamulu;
        document.getElementById('total_blocks_cost').value = overallBlocksCost.toFixed(2);
    }
</script>
</body>
</html>
