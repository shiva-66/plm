<!DOCTYPE html>
<html>
<head>
    <title>Stage 3</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            width: 80%;
            margin: auto;
            text-align: center;
        }
        .accordion {
            background-color: #f2f2f2;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            transition: 0.4s;
            position: relative;
        }
        .accordion::after {
            content: '\25BC';
            font-size: 16px;
            position: absolute;
            right: 10px;
            transition: transform 0.4s;
        }
        .active::after {
            transform: rotate(180deg);
        }
        .active, .accordion:hover {
            background-color: #ccc;
        }
        .panel {
            padding: 10px;
            display: none;
            overflow: hidden;
            background-color: white;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
            width: 50%;
        }
        th {
            background-color: #f2f2f2;
            color: black;
        }
        input {
            width: 90%;
            padding: 5px;
        }
        .submit {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #0066b2;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            width: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>STAGE-3. SLABS Production</h2>
        <form id="inventoryForm">
            <button type="button" class="accordion">General Information</button>
            <div class="panel">
                <table>
                    <tr><th>Date of Production</th><td><input type="date" name="date_of_production" id="date_of_production"></td></tr>
                    <tr><th>Block No.</th><td><input type="text" name="block_no" id="block_no"></td></tr>
                    <tr><th>Block Colour</th><td><input type="text" name="block_colour" id="block_colour"></td></tr>
                   <tr><th>Block Parts</th><td>
						<select name="block_parts" id="block_parts">
							<option value="part_a">Part A</option>
							<option value="part_b">Part B</option>
							<option value="part_c">Part C</option>
						</select></td></tr>
                    <tr><th>Block Qty. (CBM)</th><td><input type="number" step="0.001" name="block_qty" id="block_qty"></td></tr>
                    <tr><th>Slabs Expected Qty.</th><td><input type="text" name="slabs_expected_qty" id="slabs_expected_qty"></td></tr>
                    <tr><th>Blade M/c No.</th><td><input type="text" name="blade_mc_no" id="blade_mc_no"></td></tr>
                </table>
            </div>
            
            <button type="button" class="accordion">SLABS Production Qty (SFT)</button>
            <div class="panel">
                <table>
                    <tr><th>Thickness (18mm/20mm/etc)</th><td><input type="text" name="thickness" id="thickness"></td></tr>
                    <tr><th>Length (After Chipping & Grinding)</th><td><input type="number" name="length" id="length"></td></tr>
                    <tr><th>Height (After Chipping & Grinding)</th><td><input type="number" name="height" id="height"></td></tr>
                </table>
            </div>

            <button type="button" class="accordion">Production Qty</button>
            <div class="panel">
                <table>
                    <tr><th>Production (PCS)</th><td><input type="number" name="pcs" id="pcs"></td></tr>
                    <tr><th>Production (SFT)</th><td><input type="number" step="0.001" name="sft" id="sft"></td></tr>
                </table>
            </div>

            <button type="button" class="accordion">Incharge Information</button>
            <div class="panel">
                <table>
                    <tr><th>Operator Name</th><td><input type="text" name="operator_name" id="operator_name"></td></tr>
                    <tr><th>Tekedar Name</th><td><input type="text" name="tekedar_name" id="tekedar_name"></td></tr>
                </table>
            </div>
            
            <br>
            <input type="submit" class="submit" value="Submit">
        </form>
    </div>

    <script>
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.display === "block") {
                    panel.style.display = "none";
                } else {
                    panel.style.display = "block";
                }
            });
        }
		
		["length", "height", "pcs"].forEach(id => {
                document.getElementById(id).addEventListener("input", calculateProductionSft);
            });
			
		function calculateProductionSft(){
			let length = parseInt(getValue("length"));
			let height = parseInt(getValue("height"));
			let pcs = parseInt(getValue("pcs"));
			let sft = (length * height)/144 * pcs
			document.getElementById("sft").value = sft.toFixed(3);
		}

		
		document.getElementById("inventoryForm").addEventListener("submit", function(event) {
			event.preventDefault(); 
			let isValid = true;

			this.querySelectorAll('input[required]').forEach(input => {
				if (!input.value.trim()) {
					isValid = false;
					input.classList.add("error");
				} else {
					input.classList.remove("error");
				}
			});

			if (isValid) {
				submitForm();
				alert("Submit form has got triggered!");
			} else {
				alert("Please fill all required fields.");
			}
		});
		
	/*function submitForm(){
		event.preventDefault();
		    let recordId = "67dcbd0c420df42a0000062d"; // Replace with actual record ID
			let blockPart = getValue("block_parts").toLowerCase().trim(); // Get block part input value

			if (!blockPart) {
				alert("Please enter a Block Part.");
				return;
			}


		/*fetch(`https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`, {
			method: "GET",
			headers: {
				"x-api-key": "657c53fe63ede92cdbf17208",
				"Content-Type": "application/json"
			}
		})
		.then(response => response.json())
		.then(existingData => {
			let existingPart = existingData.dressing?.[blockPart] || {}; // Preserve existing properties
			let existingSlabsProduction = existingPart.slabs_production || {}; // Preserve existing slabs_production properties

			let updatedSlabsProduction = {
				...existingSlabsProduction, // Keep existing slabs_production data
				slabs_expected_qty: getValue("slabs_expected_qty"),
				blade_mc_no: getValue("blade_mc_no"),
				thickness: getValue("thickness"),
				length: getValue("length"),
				height: getValue("height"),
				production_pcs: getValue("pcs"),
				production_sft: getValue("sft"),
				operator_name: getValue("operator_name"),
				tekedar_name: getValue("tekedar_name")
			};

			let updatedPart = {
				...existingPart, // Preserve other part_x properties
				slabs_production: updatedSlabsProduction // Update only slabs_production
			};

			let updatedData = {
				dressing: {
					...existingData.dressing, // Keep other parts intact
					[blockPart]: updatedPart // Update the correct part_x
				}
			};
			// If there are updates, send a PATCH request
			if (Object.keys(updatedData).length > 0) {
				fetch(`https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`, {
					method: "POST",
					headers: {
						"x-api-key": "657c53fe63ede92cdbf17208",
						"Content-Type": "application/json"
					},
					body: JSON.stringify(updatedData)
				})
				.then(response => response.json())
				.then(data => {
					alert("Stage-3 empty values updated successfully!");
				})
				.catch(error => {
					alert("Error updating Stage-3 data.");
				});
			} else {
				alert("No empty fields were found to update.");
			}
		})
		.catch(error => {
			alert("Error fetching existing data.");
		});
		
		// WARNING: For GET requests, body is set to null by browsers.

		var xhr = new XMLHttpRequest();
		//xhr.withCredentials = true;

		xhr.addEventListener("readystatechange", function() {
		  if(this.readyState === 4) {
			console.log(this.responseText);
			let existingPart = existingData.dressing?.[blockPart] || {}; // Preserve existing properties
			let existingSlabsProduction = existingPart.slabs_production || {}; // Preserve existing slabs_production properties

			let updatedSlabsProduction = {
				...existingSlabsProduction, // Keep existing slabs_production data
				slabs_expected_qty: getValue("slabs_expected_qty"),
				blade_mc_no: getValue("blade_mc_no"),
				thickness: getValue("thickness"),
				length: getValue("length"),
				height: getValue("height"),
				production_pcs: getValue("pcs"),
				production_sft: getValue("sft"),
				operator_name: getValue("operator_name"),
				tekedar_name: getValue("tekedar_name")
			};

			let updatedPart = {
				...existingPart, // Preserve other part_x properties
				slabs_production: updatedSlabsProduction // Update only slabs_production
			};

			let updatedData = {
				dressing: {
					...existingData.dressing, // Keep other parts intact
					[blockPart]: updatedPart // Update the correct part_x
				}
			};
			// If there are updates, send a PATCH request
			if (Object.keys(updatedData).length > 0) {
				
				var xhr = new XMLHttpRequest();
				//xhr.withCredentials = true;

				xhr.addEventListener("readystatechange", function() {
				  if(this.readyState === 4) {
					console.log(this.responseText);
				  }
				});

				xhr.open("POST", "https://shivadb-f348.restdb.io/rest/plm-products-db");
				xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
				xhr.setRequestHeader("Content-Type", "application/json");

				xhr.send(updatedData);
			} else {
				alert("No empty fields were found to update.");
			}
		  }
		});

		xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
		xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");

		xhr.send();
		
	}*/
	
		function submitForm() {
			event.preventDefault();

			let recordId = "67dcbd0c420df42a0000062d"; // Replace with actual record ID
			let blockPart = getValue("block_parts").toLowerCase().trim(); 

			if (!blockPart) {
				alert("Please select a Block Part.");
				return;
			}

			var xhr = new XMLHttpRequest();

			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						let existingData = JSON.parse(xhr.responseText);
						updateRecord(existingData, blockPart, recordId);
					} else if (xhr.status === 404) {
						alert("Error: Record not found. Please check the record ID.");
					} else {
						alert("Error fetching existing data. Status: " + xhr.status);
					}
				}
			};

			xhr.open("GET", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
			xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
			xhr.send();
		}

		function updateRecord(existingData, blockPart, recordId) {
			let existingPart = existingData.dressing?.[blockPart] || {}; 
			let existingSlabsProduction = existingPart.slabs_production || {}; 

			let updatedSlabsProduction = {
				...existingSlabsProduction, 
				slabs_expected_qty: getValue("slabs_expected_qty"),
				blade_mc_no: getValue("blade_mc_no"),
				thickness: getValue("thickness"),
				length: getValue("length"),
				height: getValue("height"),
				production_pcs: getValue("pcs"),
				production_sft: getValue("sft"),
				operator_name: getValue("operator_name"),
				tekedar_name: getValue("tekedar_name")
			};

			let updatedPart = {
				...existingPart, 
				slabs_production: updatedSlabsProduction 
			};

			let updatedData = {
				dressing: {
					...existingData.dressing,
					[blockPart]: updatedPart 
				}
			};
			updateStage("2");

			var Xhr = new XMLHttpRequest();
			Xhr.onreadystatechange = function () {
				if (Xhr.readyState === 4) {
					if (Xhr.status === 200 || Xhr.status === 201) {
						alert("Stage-3 data updated successfully!");
					} else {
						alert("Error updating Stage-3 data. Status: " + Xhr.status);
					}
				}
			};

			Xhr.open("PATCH", `https://shivadb-f348.restdb.io/rest/plm-products-db/${recordId}`);
			Xhr.setRequestHeader("x-api-key", "657c53fe63ede92cdbf17208");
			Xhr.setRequestHeader("Content-Type", "application/json");
			Xhr.send(JSON.stringify(updatedData));
		}

	
	function getValue(id) {
		return document.getElementById(id)?.value || "";
	}
	function updateStage(newStage) {
    obj.dressing.part_a.stage = newStage;
	}

    </script>
</body>
</html>
